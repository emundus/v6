<template>
  <modal
      id="application-modal"
      name="application-modal"
      :height="'100vh'"
      :width="'100vw'"
      styles="display:flex;flex-direction:column;justify-content:center;align-items:center;"
      @before-open="beforeOpen"
      @before-close="updateURL()"
      @closed="$emit('getFiles')"
  >
    <div class="em-modal-header em-w-100 em-h-50 em-p-12-16 em-bg-main-900 em-flex-row">
      <div class="em-flex-row em-pointer em-gap-8" id="evaluation-modal-close">
        <div class="em-w-max-content em-flex-row" @click="$modal.hide('application-modal')">
          <span class="material-icons-outlined em-font-size-16" style="color: white">arrow_back</span>
        </div>
        <span class="em-text-neutral-500">|</span>
        <p class="em-font-size-14" style="color: white">
          {{ file.applicant_name }} - {{ file.fnum }}
        </p>
      </div>
    </div>

    <div class="modal-grid">
      <div id="modal-applicationform">
        <div class="scrollable">
          <div class="em-flex-row em-flex-center em-gap-16 em-border-bottom-neutral-300 sticky-tab">
            <div v-for="tab in tabs" class="em-light-tabs em-pointer" @click="selected = tab.name" :class="selected === tab.name ? 'em-light-selected-tab' : ''">
              <span class="em-font-size-14">{{ translate(tab.label) }}</span>
            </div>
          </div>

          <div v-if="selected === 'application'" v-html="applicationform"></div>
          <Attachments
              v-if="selected === 'attachments'"
              :fnum="file.fnum"
              :user="$props.user"
              :columns="['name','date','category','status']"
              :displayEdit="false"
          />
        </div>
      </div>

      <div id="modal-evaluationgrid">
        <div class="em-flex-column" v-if="!loading" style="width: 40px;height: 40px;margin: 24px 0 12px 24px;">
          <div class="em-circle-main-100 em-flex-column" style="width: 40px">
            <div class="em-circle-main-200 em-flex-column" style="width: 24px">
              <span class="material-icons-outlined em-main-400-color" style="font-size: 14px">troubleshoot</span>
            </div>
          </div>
        </div>
        <iframe v-if="url" :src="url" class="iframe-evaluation" id="iframe-evaluation" @load="iframeLoaded($event);" title="Evaluation form" />
        <div class="em-page-loader" v-if="loading"></div>
      </div>
    </div>
  </modal>
</template>

<script>
import axios from "axios";
import Attachments from "@/views/Attachments";
import filesService from 'com_emundus/src/services/files';
import errors from "@/mixins/errors";


export default {
  name: "Application",
  components: {Attachments},
  props: {
    file: Object,
    type: String,
    user: {
      type: String,
      required: true,
    },
  },
  mixins: [errors],
  data: () => ({
    applicationform: '',
    selected: 'application',
    tabs: [
      {
        label: 'COM_EMUNDUS_FILES_APPLICANT_FILE',
        name: 'application'
      },
      {
        label: 'COM_EMUNDUS_FILES_ATTACHMENTS',
        name: 'attachments'
      },
      {
        label: 'COM_EMUNDUS_FILES_COMMENTS',
        name: 'comments'
      },
    ],
    evaluation_form: 0,
    url: null,

    loading: false
  }),

  methods:{
    beforeOpen(){
      this.loading = true;

      filesService.checkAccess(this.$props.file.fnum).then((result) => {
        if(result.data === true){
          this.updateURL(this.$props.file.fnum)
          this.getApplicationForm();
          if(this.$props.type === 'evaluation'){
            this.getEvaluationForm();
          }
        } else {
         this.displayError(
             'COM_EMUNDUS_FILES_CANNOT_ACCESS',
             'COM_EMUNDUS_FILES_CANNOT_ACCESS_DESC'
         ).then((confirm) => {
           if(confirm === true){
             this.$modal.hide('application-modal');
           }
         });
        }
      });

    },

    getApplicationForm(){
      axios({
        method: "get",
        url: "index.php?option=com_emundus&view=application&format=raw&layout=form&fnum="+this.file.fnum,
      }).then(response => {
        this.applicationform = response.data;
        if(this.$props.type !== 'evaluation'){
          this.loading = false;
        }
      });
    },
    getEvaluationForm(){
      if (this.$props.file.id != null) {
        this.rowid = this.$props.file.id;
      }
      if (this.$props.file.student_id != null) {
        this.student_id = this.$props.file.student_id;
      }
      let view = 'form';

      filesService.getEvaluationFormByFnum(this.$props.file.fnum).then((response) => {
        if(response.data !== 0) {
          this.url = 'index.php?option=com_fabrik&c=form&view=' + view + '&formid=' + response.data + '&rowid=' + this.rowid + '&jos_emundus_evaluations___student_id[value]=' + this.student_id + '&jos_emundus_evaluations___campaign_id[value]=' + this.$props.file.campaign_id + '&jos_emundus_evaluations___fnum[value]=' + this.$props.file.fnum + '&student_id=' + this.student_id + '&tmpl=component&iframe=1'
        }
      });
    },
    iframeLoaded(event){
      this.loading = false;
    },
    updateURL(fnum = ''){
      let url = window.location.href;
      url = url.split('#');

      if(fnum === '') {
        window.history.pushState('', '', url[0]);
      } else {
        window.history.pushState('', '', url[0] + '#' + fnum);
      }
    }
  }
}
</script>

<style>
.modal-grid {
  display: grid;
  grid-template-columns: 66% 33%;
  grid-gap: 16px;
  width: 100%;
  height: 100vh;
}
.scrollable {
  height: calc(100vh - 100px);
  overflow-y: scroll;
  overflow-x: hidden;
}
.em-container-form-heading{
  display: none;
}
#iframe{
  height: 100vh;
  overflow-y: scroll;
  overflow-x: hidden;
}
.iframe-evaluation{
  width: 100%;
  height: 90%;
  border: unset;
}
#modal-evaluationgrid{
  border-left: 1px solid #EBECF0;
  box-shadow: 0px 4px 16px rgba(32, 35, 44, 0.1);
}
.sticky-tab{
  position: sticky;
  top: 0;
  background: white;
}
#modal-applicationform #em-attachments .v--modal-overlay{
  height: 100% !important;
  width: 67% !important;
  margin-top: 50px;
}
#modal-applicationform #em-attachments .v--modal-box.v--modal{
  width: 100% !important;
  height: calc(100vh - 50px) !important;
  box-shadow: unset;
}
#modal-applicationform #em-attachments .modal-body{
  width: 100%;
}
#modal-applicationform #em-attachments #em-attachment-preview{
  width: 100%;
}
</style>