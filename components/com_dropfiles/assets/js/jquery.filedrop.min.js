/*
 * Default text - jQuery plugin for html5 dragging files from desktop to browser
 * Author: Weixi Yen
 * Copyright (c) 2010 Resopollution
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 * Project home:
 *   http://www.github.com/weixiyen/jquery-filedrop
 */
!function(e){var r={fallback_id:"",fallback_dropzoneClick:!1,url:"",refresh:1e3,paramname:"userfile",requestType:"POST",allowedfileextensions:[],allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:n,dragStart:n,dragEnter:n,dragOver:n,dragLeave:n,docEnter:n,docOver:n,docLeave:n,beforeEach:n,afterAll:n,rename:n,error:function(e,r,t,n){alert(e)},uploadStarted:n,uploadFinished:n,progressUpdated:n,globalProgressUpdated:n,speedUpdated:n},t=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed","NotFound","NotReadable","AbortError","ReadError","FileExtensionNotAllowed"];function n(){}e.fn.filedrop=function(n){var a,o,i=e.extend({},r,n),l=[],s=!1,d=0;if(!0===i.fallback_dropzoneClick&&e("#"+i.fallback_id).css({display:"none",width:0,height:0}),this.on("drop",function(e){if(!1===i.drop.call(this,e))return!1;if(!e.originalEvent.dataTransfer)return;if(null==(o=e.originalEvent.dataTransfer.files)||0===o.length)return i.error(t[0]),!1;return d=o.length,p(),e.preventDefault(),!1}).on("dragstart",i.dragStart).on("dragenter",function(e){clearTimeout(a),e.preventDefault(),i.dragEnter.call(this,e)}).on("dragover",function(e){clearTimeout(a),e.preventDefault(),i.docOver.call(this,e),i.dragOver.call(this,e)}).on("dragleave",function(e){clearTimeout(a),i.dragLeave.call(this,e),e.stopPropagation()}),e(document).on("drop",function(e){return e.preventDefault(),i.docLeave.call(this,e),!1}).on("dragenter",function(e){return clearTimeout(a),e.preventDefault(),i.docEnter.call(this,e),!1}).on("dragover",function(e){return clearTimeout(a),e.preventDefault(),i.docOver.call(this,e),!1}).on("dragleave",function(e){a=setTimeout((r=this,function(){i.docLeave.call(r,e)}),200);var r}),!0===i.fallback_dropzoneClick){if(this.find("#"+i.fallback_id).length>0)throw"Fallback element ["+i.fallback_id+"] cannot be inside dropzone, unless option fallback_dropzoneClick is false";this.on("click",function(r){e("#"+i.fallback_id).trigger(r)}),e("#"+i.fallback_id).change(function(e){i.drop(e),o=e.target.files,d=o.length,p()})}function u(r,t,n,a){var o="\r\n",l="",s=i.paramname;if(i.data){var d=e.param(i.data).replace(/\+/g,"%20").split(/&/);e.each(d,function(){var e=this.split("=",2),r=decodeURIComponent(e[0]),t=decodeURIComponent(e[1]);2===e.length&&(l+="--",l+=a,l+=o,l+='Content-Disposition: form-data; name="'+r+'"',l+=o,l+=o,l+=t,l+=o)})}return jQuery.isFunction(s)&&(s=s(r)),l+="--",l+=a,l+=o,l+='Content-Disposition: form-data; name="'+(s||"")+'"',l+='; filename="'+encodeURIComponent(r)+'"',l+=o,l+="Content-Type: "+n,l+=o,l+=o,l+=t,l+=o,l+="--",l+=a,l+="--",l+=o}function f(e){if(e.lengthComputable){var r=Math.round(100*e.loaded/e.total);if(this.currentProgress!==r){this.currentProgress=r,i.progressUpdated(this.index,this.file,this.currentProgress),l[this.global_progress_index]=this.currentProgress,c();var t=(new Date).getTime(),n=t-this.currentStart;if(n>=i.refresh){var a=(e.loaded-this.startData)/n;i.speedUpdated(this.index,this.file,a),this.startData=e.loaded,this.currentStart=t}}}}function c(){if(0!==l.length){var e,r=0;for(e in l)l.hasOwnProperty(e)&&(r+=l[e]);i.globalProgressUpdated(Math.round(r/l.length))}}function p(){if(s=!1,!o)return i.error(t[0]),!1;if(i.allowedfiletypes.push&&i.allowedfiletypes.length)for(var r=o.length;r--;)if(!o[r].type||e.inArray(o[r].type,i.allowedfiletypes)<0)return i.error(t[3],o[r]),!1;if(i.allowedfileextensions.push&&i.allowedfileextensions.length)for(r=o.length;r--;){var n=!1;for(m=0;m<i.allowedfileextensions.length;m++)o[r].name.substr(o[r].name.length-i.allowedfileextensions[m].length).toLowerCase()==i.allowedfileextensions[m].toLowerCase()&&(n=!0);if(!n)return i.error(t[8],o[r]),!1}var a=0,p=0;if(d>i.maxfiles&&0===i.queuefiles)return i.error(t[1]),!1;for(var h=[],g=[],v=[],m=0;m<d;m++)h.push(m);var y=function(){var e,r,n;if(s)return!1;if(i.queuefiles>0&&g.length>=i.queuefiles)return r=i.queuewait,void setTimeout(y,r);e=h[0],h.splice(0,1),g.push(e);try{if(!1!==(n=o[e],i.beforeEach(n))){if(e===d)return;var a=new FileReader,l=1048576*i.maxfilesize;if(a.index=e,o[e].size>l)return i.error(t[2],o[e],e),g.forEach(function(r,t){r===e&&g.splice(t,1)}),p++,!0;a.onerror=function(e){switch(e.target.error.code){case e.target.error.NOT_FOUND_ERR:return i.error(t[4]),!1;case e.target.error.NOT_READABLE_ERR:return i.error(t[5]),!1;case e.target.error.ABORT_ERR:return i.error(t[6]),!1;default:return i.error(t[7]),!1}},a.onloadend=i.beforeSend?function(r){i.beforeSend(o[e],e,function(){w(r)})}:w,a.readAsDataURL(o[e])}else p++}catch(r){return g.forEach(function(r,t){r===e&&g.splice(t,1)}),i.error(t[0]),!1}h.length>0&&y()},w=function(r){var t=(r.srcElement||r.target).index;void 0===r.target.index&&(r.target.index=function(e){for(var r=0;r<d;r++)if(o[r].size===e)return r;return}(r.total));var n,h,m=new XMLHttpRequest,y=m.upload,w=o[r.target.index],b=r.target.index,T=(new Date).getTime(),x="------multipartformboundary"+(new Date).getTime(),R=l.length,A=(h=w.name,i.rename(h)),E=w.type;i.withCredentials&&(m.withCredentials=i.withCredentials);var _=r.target.result.split(",")[1],C=void 0===_?"":atob(_);n=u("string"==typeof A?A:w.name,C,E,x),y.index=b,y.file=w,y.downloadStartTime=T,y.currentStart=T,y.currentProgress=0,y.global_progress_index=R,y.startData=0,y.addEventListener("progress",f,!1),jQuery.isFunction(i.url)?m.open(i.requestType,i.url(y),!0):m.open(i.requestType,i.url,!0),m.setRequestHeader("content-type","multipart/form-data; boundary="+x),m.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.each(i.headers,function(e,r){m.setRequestHeader(e,r)}),m.sendAsBinary||(m.sendAsBinary=function(e){var r=Array.prototype.map.call(e,function(e){return 255&e.charCodeAt(0)}),t=new Uint8Array(r);this.send(t.buffer)}),m.sendAsBinary(n),l[R]=0,c(),i.uploadStarted(b,w,d),m.onload=function(){var e=null;if(m.responseText)try{e=jQuery.parseJSON(m.responseText)}catch(r){e=m.responseText}var r=(new Date).getTime()-T,n=i.uploadFinished(b,w,e,r,m);a++,g.forEach(function(e,r){e===t&&g.splice(r,1)}),v.push(t),l[R]=100,c(),a===d-p&&i.afterAll(),!1===n&&(s=!0),(m.status<200||m.status>299)&&i.error(m.statusText,w,t,m.status)}};y()}return this};try{if(XMLHttpRequest.prototype.sendAsBinary)return;XMLHttpRequest.prototype.sendAsBinary=function(e){var r=Array.prototype.map.call(e,function(e){return 255&e.charCodeAt(0)}),t=new Uint8Array(r);"ArrayBufferView"in window?this.send(t):this.send(t.buffer)}}catch(e){}}(jQuery);