/*! Fabrik */

define(["jquery"],function(jQuery){var ListForm=new Class({autoChangeDbName:!0,Implements:[Options],options:{j3:!0},initialize:function(e){var t;window.addEvent("domready",function(){this.setOptions(e),this.watchTableDd(),this.watchLabel(),document.id("addAJoin")&&document.id("addAJoin").addEvent("click",function(e){e.stop(),this.addJoin()}.bind(this)),document.getElement("table.linkedLists")&&(t=document.getElement("table.linkedLists").getElement("tbody"),new Sortables(t,{handle:".handle",onSort:function(e,t){var n=this.serialize(1,function(e){return e.getElement("input")?e.getElement("input").name.split("][").getLast().replace("]",""):""}),o=[];n.each(function(e){""!==e&&o.push(e)}),document.getElement("input[name*=faceted_list_order]").value=JSON.stringify(o)}})),document.getElement("table.linkedForms")&&(t=document.getElement("table.linkedForms").getElement("tbody"),new Sortables(t,{handle:".handle",onSort:function(e,t){var n=this.serialize(1,function(e){return e.getElement("input")?e.getElement("input").name.split("][").getLast().replace("]",""):""}),o=[];n.each(function(e){""!==e&&o.push(e)}),document.getElement("input[name*=faceted_form_order]").value=JSON.stringify(o)}})),this.joinCounter=0,this.watchOrderButtons(),this.watchDbName(),this.watchJoins()}.bind(this))},watchLabel:function(){this.autoChangeDbName=""===jQuery("#jform__database_name").val(),jQuery("#jform_label").on("keyup",function(e){if(this.autoChangeDbName){var t=jQuery("#jform_label").val().trim().toLowerCase();t=t.replace(/\W+/g,"_"),jQuery("#jform__database_name").val(t)}}.bind(this)),jQuery("#jform__database_name").on("keyup",function(){this.autoChangeDbName=!1}.bind(this))},watchOrderButtons:function(){document.getElements(".addOrder").removeEvents("click"),document.getElements(".deleteOrder").removeEvents("click"),document.getElements(".addOrder").addEvent("click",function(e){e.stop(),this.addOrderBy()}.bind(this)),document.getElements(".deleteOrder").addEvent("click",function(e){e.stop(),this.deleteOrderBy(e)}.bind(this))},addOrderBy:function(e){var t;(t=e?e.target.getParent(".orderby_container"):document.getElement(".orderby_container")).clone().inject(t,"after"),this.watchOrderButtons()},deleteOrderBy:function(e){1<document.getElements(".orderby_container").length&&(e.target.getParent(".orderby_container").dispose(),this.watchOrderButtons())},watchDbName:function(){document.id("database_name")&&document.id("database_name").addEvent("blur",function(e){""===document.id("database_name").get("value")?document.id("tablename").disabled=!1:document.id("tablename").disabled=!0})},_buildOptions:function(e,t){var n=[];return 0<e.length&&("object"==typeof e[0]?e.each(function(e){e[0]===t?n.push(new Element("option",{value:e[0],selected:"selected"}).set("text",e[1])):n.push(new Element("option",{value:e[0]}).set("text",e[1]))}):e.each(function(e){e===t?n.push(new Element("option",{value:e,selected:"selected"}).set("text",e)):n.push(new Element("option",{value:e}).set("text",e))})),n},watchTableDd:function(){document.id("tablename")&&document.id("tablename").addEvent("change",function(e){var cid=document.getElement("input[name*=connection_id]").get("value"),table=document.id("tablename").get("value"),url="index.php?option=com_fabrik&format=raw&task=list.ajax_updateColumDropDowns&cid="+cid+"&table="+table,myAjax=new Request({url:url,method:"post",onComplete:function(r){eval(r)}}).send()})},watchFieldList:function(e){document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(select[name*="+e+"])",function(e,t){var n=this.options.j3?"tr":"table";this.updateJoinStatement(t.getParent(n).id.replace("join",""))}.bind(this))},_findActiveTables:function(){document.getElements(".join_from").combine(document.getElements(".join_to")).each(function(e){var t=e.get("value");-1===this.options.activetableOpts.indexOf(t)&&this.options.activetableOpts.push(t)}.bind(this)),this.options.activetableOpts.sort()},addJoin:function(e,t,n,o,i,a,d,l,s,m){var r,u,c,p;n=n||"left",d=d||"",o=o||"",i=i||"",a=a||"",e=e||"",t=t||"",(m=m||!1)?(r='checked="checked"',u=""):(u='checked="checked"',r=""),this._findActiveTables(),l=l||[["-",""]],s=s||[["-",""]];var h=new Element("tbody"),_=new Element("input",{readonly:"readonly",size:"2",class:"disabled readonly input-mini",name:"jform[params][join_id][]",value:t}),b=this.options.js?"btn-danger":"removeButton",E=new Element("a",{href:"#",class:"btn "+b,events:{click:function(e){return this.deleteJoin(e),!1}.bind(this)}}),j='<i class="icon-minus"></i> ';this.options.j3||(j+=Joomla.JText._("COM_FABRIK_DELETE")),E.set("html",j),n=new Element("select",{name:"jform[params][join_type][]",class:"inputbox input-mini"}).adopt(this._buildOptions(this.options.joinOpts,n));var w=new Element("select",{name:"jform[params][join_from_table][]",class:"inputbox join_from input-medium"}).adopt(this._buildOptions(this.options.activetableOpts,d));e=new Element("input",{type:"hidden",name:"group_id[]",value:e});var f=new Element("select",{name:"jform[params][table_join][]",class:"inputbox join_to input-medium"}).adopt(this._buildOptions(this.options.tableOpts,o)),g=new Element("select",{name:"jform[params][table_key][]",class:"table_key inputbox input-medium"}).adopt(this._buildOptions(l,i));a=new Element("select",{name:"jform[params][table_join_key][]",class:"table_join_key inputbox input-medium"}).adopt(this._buildOptions(s,a));var v='<fieldset class="radio"><input type="radio" id="joinrepeat'+this.joinCounter+'" value="1" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+r+'/><label for="joinrepeat'+this.joinCounter+'">'+Joomla.JText._("JYES")+'</label><input type="radio" id="joinrepeatno'+this.joinCounter+'" value="0" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+u+'/><label for="joinrepeatno'+this.joinCounter+'">'+Joomla.JText._("JNO")+"</label></fieldset>";p=this.options.j3?(c=new Element("thead").adopt(new Element("tr").adopt([new Element("th").set("text","id"),new Element("th").set("text",Joomla.JText._("COM_FABRIK_JOIN_TYPE")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_REPEAT_GROUP_BUTTON_LABEL")),new Element("th")])),new Element("tr",{id:"join"+this.joinCounter}).adopt([new Element("td").adopt(_),new Element("td").adopt([e,n]),new Element("td").adopt(w),new Element("td").adopt(f),new Element("td.table_key").adopt(g),new Element("td.table_join_key").adopt(a),new Element("td").set("html",v),new Element("td").adopt(E)])):(c=new Element("thead").adopt([new Element("tr",{events:{click:function(e){e.stop();var t=e.target.getParent(".adminform").getElement("tbody"),n=new Fx.Slide(t,{duration:500});Browser.ie?t.toggle():n.toggle()}},styles:{cursor:"pointer"}}).adopt(new Element("td",{colspan:"2"}).adopt(new Element("div",{id:"join-desc-"+this.joinCounter,styles:{margin:"5px","background-color":"#fefefe",padding:"5px",border:"1px dotted #666666"}})))]),[new Element("tr").adopt([new Element("td").set("text","id"),new Element("td").adopt(_)]),new Element("tr").adopt([new Element("td").adopt([e]).set("text",Joomla.JText._("COM_FABRIK_JOIN_TYPE")),new Element("td").adopt(n)]),new Element("tr").adopt([new Element("td").set("text",Joomla.JText._("COM_FABRIK_FROM")),new Element("td").adopt(w)]),new Element("tr").adopt([new Element("td").set("text",Joomla.JText._("COM_FABRIK_TO")),new Element("td").adopt(f)]),new Element("tr").adopt([new Element("td").set("text",Joomla.JText._("COM_FABRIK_FROM_COLUMN")),new Element("td",{id:"joinThisTableId"+this.joinCounter}).adopt(g)]),new Element("tr").adopt([new Element("td").set("text",Joomla.JText._("COM_FABRIK_TO_COLUMN")),new Element("td",{id:"joinJoinTableId"+this.joinCounter}).adopt(a)]),new Element("tr").set("html","<td>"+Joomla.JText._("COM_FABRIK_REPEAT_GROUP_BUTTON_LABEL")+"</td><td>"+v+"</td>"),new Element("tr").adopt([new Element("td",{colspan:"2"}).adopt([E])])]);var O=this.options.j3?"table-striped":"adminform",y=this.options.j3?"":"join"+this.joinCounter,J=new Element("table",{class:O+" table",id:y}).adopt([c,h.adopt(p)]);if(this.options.j3)if(0===this.joinCounter)J.inject(document.id("joindtd"));else{var x=document.id("joindtd").getElement("tbody");p.inject(x)}else{if(new Element("div",{id:"join"}).adopt(J).inject(document.id("joindtd")),""!==i){var T=new Fx.Slide(h,{duration:500});Browser.ie?h.hide():T.slideIn()}this.updateJoinStatement(this.joinCounter)}this.joinCounter++},deleteJoin:function(e){var t,n;e.stop(),this.options.j3?(n=e.target.getParent("tr"),t=e.target.getParent("table")):n=document.id(e.target.up(4)),n.dispose(),this.options.j3&&0===t.getElements("tbody tr").length&&t.dispose()},watchJoins:function(){var s=this.options.j3?"tr":"table";document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_from)",function(e,t){var n=t.getParent(s),o=n.id.replace("join","");this.updateJoinStatement(o);var i=t.get("value"),a=document.getElement("input[name*=connection_id]").get("value"),d=this.options.j3?n.getElement("td.table_key"):document.id("joinThisTableId"+o),l="index.php?option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+i+"&conn="+a;new Request.HTML({url:l,method:"post",update:d}).send()}.bind(this)),document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_to)",function(e,t){var n=t.getParent(s),o=n.id.replace("join","");this.updateJoinStatement(o);var i="index.php?name=jform[params][table_join_key][]&option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+t.get("value")+"&conn="+document.getElement("input[name*=connection_id]").get("value"),a=this.options.j3?n.getElement("td.table_join_key"):document.id("joinJoinTableId"+o);new Request.HTML({url:i,method:"post",update:a}).send()}.bind(this)),this.watchFieldList("join_type"),this.watchFieldList("table_join_key"),this.watchFieldList("table_key")},updateJoinStatement:function(e){var t=document.getElements("#join"+e+" .inputbox"),n=(t=Array.mfrom(t))[0].get("value"),o=t[1].get("value"),i=t[2].get("value"),a=n+" JOIN "+i+" ON "+o+"."+t[3].get("value")+" = "+i+"."+t[4].get("value"),d=document.id("join-desc-"+e);"null"!==typeOf(d)&&d.set("html",a)}});return ListForm});