/*! Fabrik */

define(["jquery"],function(jQuery){var ListForm=new Class({autoChangeDbName:!0,Implements:[Options],initialize:function(e){var t;window.addEvent("domready",function(){this.setOptions(e),this.watchTableDd(),this.watchLabel(),document.id("addAJoin")&&document.id("addAJoin").addEvent("click",function(e){e.stop(),this.addJoin()}.bind(this)),document.getElement("table.linkedLists")&&(t=document.getElement("table.linkedLists").getElement("tbody"),new Sortables(t,{handle:".handle",onSort:function(e,t){var n=this.serialize(1,function(e){return e.getElement("input")?e.getElement("input").name.split("][").getLast().replace("]",""):""}),a=[];n.each(function(e){""!==e&&a.push(e)}),document.getElement("input[name*=faceted_list_order]").value=JSON.stringify(a)}})),document.getElement("table.linkedForms")&&(t=document.getElement("table.linkedForms").getElement("tbody"),new Sortables(t,{handle:".handle",onSort:function(e,t){var n=this.serialize(1,function(e){return e.getElement("input")?e.getElement("input").name.split("][").getLast().replace("]",""):""}),a=[];n.each(function(e){""!==e&&a.push(e)}),document.getElement("input[name*=faceted_form_order]").value=JSON.stringify(a)}})),this.joinCounter=0,this.watchOrderButtons(),this.watchDbName(),this.watchJoins()}.bind(this))},watchLabel:function(){this.autoChangeDbName=""===jQuery("#jform__database_name").val(),jQuery("#jform_label").on("keyup",function(e){if(this.autoChangeDbName){var t=jQuery("#jform_label").val().trim().toLowerCase();t=t.replace(/\W+/g,"_"),jQuery("#jform__database_name").val(t)}}.bind(this)),jQuery("#jform__database_name").on("keyup",function(){this.autoChangeDbName=!1}.bind(this))},watchOrderButtons:function(){document.getElements(".addOrder").removeEvents("click"),document.getElements(".deleteOrder").removeEvents("click"),document.getElements(".addOrder").addEvent("click",function(e){e.stop(),this.addOrderBy()}.bind(this)),document.getElements(".deleteOrder").addEvent("click",function(e){e.stop(),this.deleteOrderBy(e)}.bind(this))},addOrderBy:function(e){var t;(t=e?e.target.getParent(".orderby_container"):document.getElement(".orderby_container")).clone().inject(t,"after"),this.watchOrderButtons()},deleteOrderBy:function(e){1<document.getElements(".orderby_container").length&&(e.target.getParent(".orderby_container").dispose(),this.watchOrderButtons())},watchDbName:function(){document.id("database_name")&&document.id("database_name").addEvent("blur",function(e){""===document.id("database_name").get("value")?document.id("tablename").disabled=!1:document.id("tablename").disabled=!0})},_buildOptions:function(e,t){var n=[];return 0<e.length&&("object"==typeof e[0]?e.each(function(e){e[0]===t?n.push(new Element("option",{value:e[0],selected:"selected"}).set("text",e[1])):n.push(new Element("option",{value:e[0]}).set("text",e[1]))}):e.each(function(e){e===t?n.push(new Element("option",{value:e,selected:"selected"}).set("text",e)):n.push(new Element("option",{value:e}).set("text",e))})),n},watchTableDd:function(){document.id("tablename")&&document.id("tablename").addEvent("change",function(e){var cid=document.getElement("input[name*=connection_id]").get("value"),table=document.id("tablename").get("value"),url="index.php?option=com_fabrik&format=raw&task=list.ajax_updateColumDropDowns&cid="+cid+"&table="+table,myAjax=new Request({url:url,method:"post",onComplete:function(r){eval(r)}}).send()})},watchFieldList:function(e){document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(select[name*="+e+"])",function(e,t){this.updateJoinStatement(t.getParent("tr").id.replace("join",""))}.bind(this))},_findActiveTables:function(){document.getElements(".join_from").combine(document.getElements(".join_to")).each(function(e){var t=e.get("value");-1===this.options.activetableOpts.indexOf(t)&&this.options.activetableOpts.push(t)}.bind(this)),this.options.activetableOpts.sort()},addJoin:function(e,t,n,a,i,o,l,d,s,m){var r,c,u,p;n=n||"left",l=l||"",a=a||"",i=i||"",o=o||"",e=e||"",t=t||"",(m=m||!1)?(r='checked="checked"',c=""):(c='checked="checked"',r=""),this._findActiveTables(),d=d||[["-",""]],s=s||[["-",""]];var h=new Element("tbody"),b=new Element("input",{readonly:"readonly",size:"2",class:"disabled readonly input-mini",name:"jform[params][join_id][]",value:t}),_=new Element("a",{href:"#",class:"btn btn-danger btn-sm",events:{click:function(e){return this.deleteJoin(e),!1}.bind(this)}});_.set("html",'<i class="icon-minus"></i> '),n=new Element("select",{name:"jform[params][join_type][]",class:"form-select-sm inputbox"}).adopt(this._buildOptions(this.options.joinOpts,n));var f=new Element("select",{name:"jform[params][join_from_table][]",class:"form-select-sm join_from inputbox"}).adopt(this._buildOptions(this.options.activetableOpts,l));e=new Element("input",{type:"hidden",name:"group_id[]",value:e});var E=new Element("select",{name:"jform[params][table_join][]",class:"form-select-sm join_to inputbox"}).adopt(this._buildOptions(this.options.tableOpts,a)),g=new Element("select",{name:"jform[params][table_key][]",class:"table_key inputbox form-select-sm"}).adopt(this._buildOptions(d,i));o=new Element("select",{name:"jform[params][table_join_key][]",class:"table_join_key inputbox form-select-sm"}).adopt(this._buildOptions(s,o));var v='<fieldset class="radio"><input type="radio" id="joinrepeatno'+this.joinCounter+'" value="0" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+c+'/><label style="padding: 0.1rem 0.6rem 0.1rem 0.2rem" for="joinrepeatno'+this.joinCounter+'">'+Joomla.JText._("JNO")+'</label><input type="radio" id="joinrepeat'+this.joinCounter+'" value="1" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+r+'/><label style="padding: 0.1rem 0.6rem 0.1rem 0.2rem" for="joinrepeat'+this.joinCounter+'">'+Joomla.JText._("JYES")+"</label></fieldset>";u=new Element("thead").adopt(new Element("tr").adopt([new Element("th").set("text","id"),new Element("th").set("text",Joomla.JText._("COM_FABRIK_JOIN_TYPE")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_REPEAT_GROUP_BUTTON_LABEL")),new Element("th")])),p=new Element("tr",{id:"join"+this.joinCounter}).adopt([new Element("td").adopt(b),new Element("td").adopt([e,n]),new Element("td").adopt(f),new Element("td").adopt(E),new Element("td.table_key").adopt(g),new Element("td.table_join_key").adopt(o),new Element("td").set("html",v),new Element("td").adopt(_)]);var j=new Element("table",{class:"table-striped table",id:""}).adopt([u,h.adopt(p)]);if(0===this.joinCounter)j.inject(document.id("joindtd"));else{var w=document.id("joindtd").getElement("tbody");p.inject(w)}this.joinCounter++},deleteJoin:function(e){var t,n;e.stop(),n=e.target.getParent("tr"),t=e.target.getParent("table"),n.dispose(),0===t.getElements("tbody tr").length&&t.dispose()},watchJoins:function(){document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_from)",function(e,t){var n=t.getParent("tr"),a=n.id.replace("join","");this.updateJoinStatement(a);var i=t.get("value"),o=document.getElement("input[name*=connection_id]").get("value"),l=n.getElement("td.table_key"),d="index.php?option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+i+"&conn="+o;new Request.HTML({url:d,method:"post",update:l}).send()}.bind(this)),document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_to)",function(e,t){var n=t.getParent("tr"),a=n.id.replace("join","");this.updateJoinStatement(a);var i="index.php?name=jform[params][table_join_key][]&option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+t.get("value")+"&conn="+document.getElement("input[name*=connection_id]").get("value"),o=n.getElement("td.table_join_key");new Request.HTML({url:i,method:"post",update:o}).send()}.bind(this)),this.watchFieldList("join_type"),this.watchFieldList("table_join_key"),this.watchFieldList("table_key")},updateJoinStatement:function(e){var t=document.getElements("#join"+e+" .inputbox"),n=(t=Array.mfrom(t))[0].get("value"),a=t[1].get("value"),i=t[2].get("value"),o=n+" JOIN "+i+" ON "+a+"."+t[3].get("value")+" = "+i+"."+t[4].get("value"),l=document.id("join-desc-"+e);"null"!==typeOf(l)&&l.set("html",o)}});return ListForm});