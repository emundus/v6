/*! Fabrik */

var fabriktablesElement=new Class({Implements:[Options,Events],options:{conn:null,connInRepeat:!0,container:""},initialize:function(e,t){this.el=e,this.setOptions(t),this.elements=[],this.elementLists=$H({}),this.waitingElements=$H({}),"null"===typeOf(document.id(this.options.conn))?this.periodical=this.getCnn.periodical(500,this):this.setUp()},getCnn:function(){"null"!==typeOf(document.id(this.options.conn))&&(this.setUp(),clearInterval(this.periodical))},registerElement:function(e){this.elements.push(e),this.updateElements()},setUp:function(){if(this.el=document.id(this.el),this.cnn=document.id(this.options.conn),"null"!==this.cnn){this.loader=document.id(this.el.id+"_loader");var t=this;this.cnn.hasClass("chzn-done")&&jQuery("#"+this.cnn.id).on("change",function(e){document.id(t.cnn).fireEvent("change",new Event.Mock(document.id(t.cnn),"change"))}),this.cnn.addEvent("change",function(e){this.updateMe(e)}.bind(this)),this.el.hasClass("chzn-done")&&jQuery("#"+this.el.id).on("change",function(e){document.id(t.el.id).fireEvent("change",new Event.Mock(document.id(t.el.id),"change"))}),this.el.addEvent("change",function(e){this.updateElements(e)}.bind(this));var e=this.cnn.get("value");""!==e&&-1!==e&&this.updateMe()}},updateMe:function(e){e&&e.stop();var t=this.cnn.get("value");if(t){this.loader&&this.loader.show();var n=new Request({url:"index.php",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",g:"element",plugin:"field",method:"ajax_tables",showf:"1",cid:t.toInt()},onSuccess:function(e){var t=JSON.parse(e);"null"!==typeOf(t)&&(t.err?alert(t.err):(this.el.empty(),t.each(function(e){var t={value:e.id};e.id===this.options.value&&(t.selected="selected"),new Element("option",t).appendText(e.label).inject(this.el)}.bind(this)),this.loader&&this.loader.hide(),this.el.hasClass("chzn-done")&&jQuery("#"+this.el.id).trigger("liszt:updated"),this.updateElements()))}.bind(this),onFailure:function(e){console.log("fabriktables request failure",e.getResponseHeader("Status"))}.bind(this),onException:function(e,t){console.log("fabriktables request exception",e,t)}.bind(this)});Fabrik.requestQueue.add(n)}},updateElements:function(){this.elements.each(function(e){var t=e.getOpts(),n=this.el.get("value");if(""!==n){this.loader&&this.loader.show();var i=t.getValues().toString()+","+n;if(this.waitingElements.has(i)||(this.waitingElements[i]=$H({})),void 0!==this.elementLists[i])""===this.elementLists[i]?this.waitingElements[i][e.el.id]=e:this.updateElementOptions(this.elementLists[i],e);else{var s=this.cnn.get("value");this.elementLists.set(i,"");var l={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",g:"element",plugin:"field",method:"ajax_fields",cid:s.toInt(),showf:"1",k:"2",t:n};t.each(function(e,t){l[t]=e});new Request({url:"index.php",data:l,onComplete:function(n){this.elementLists.set(i,n),this.updateElementOptions(n,e),this.waitingElements.get(i).each(function(e,t){this.updateElementOptions(n,e),this.waitingElements[i].erase(t)}.bind(this))}.bind(this),onFailure:function(e){this.waitingElements.get(i).each(function(e,t){this.updateElementOptions("[]",e),this.waitingElements[i].erase(t)}.bind(this)),this.loader&&this.loader.hide(),alert(e.status+": "+e.statusText)}.bind(this)}).send()}}}.bind(this))},updateElementOptions:function(r,element){var target,dotValue;if(""!==r){var table=document.id(this.el).get("value"),key=element.getOpts().getValues().toString()+","+table,opts=eval(r);target="textarea"===element.el.get("tag")?element.el.getParent().getElement("select"):element.el,target.empty();var o={value:""};""===element.options.value&&(o.selected="selected"),new Element("option",o).appendText("-").inject(target),dotValue=element.options.value.replace(".","___"),opts.each(function(e){var t=e.value.replace("[]",""),n={value:t};t!==element.options.value&&t!==dotValue||(n.selected="selected"),new Element("option",n).set("text",e.label).inject(target)}.bind(this)),this.loader&&this.loader.hide()}},cloned:function(e,t){if(!0===this.options.connInRepeat){var n=this.options.conn.split("-");n.pop(),this.options.conn=n.join("-")+"-"+t}this.el=e,this.elements=[],this.elementLists=$H({}),this.waitingElements=$H({}),this.setUp(),FabrikAdmin.model.fields.fabriktable[this.el.id]=this}});