<template>
  <div id="app">
    <div class="profile_widget mb-4">
      <h1>{{ translate('COM_EMUNDUS_DASHBOARD_AREA') }} {{ data.label }}</h1>
      <p v-if="displayDescription == 1">{{data.description}}</p>
    </div>

    <draggable
        v-model="widgets"
        :disabled="!enableDrag"
        handle=".handle"
        drag-class="plugin-drag"
        chosen-class="plugin-chosen"
        ghost-class="plugin-ghost">
      <div v-if="this.programmeFilter == 1" class="program-filter">
        <label>{{translations.filterByProgram}}</label>
        <select v-model="selectedProgramme">
          <option :value="null" selected>{{translations.all}}</option>
          <option v-for="programme in programmes" v-bind:key="programme.id" :value="programme.code">{{programme.label}}</option>
        </select>
      </div>
      <template v-if="widgets.length > 0">
        <div v-for="(widget,index) in widgets" :id="widget.name + '_' + index"
        :class="enableDrag ? 'jello-horizontal handle' : widget.name + '-' + widget.class" :key="widget.name + '_' + index">
          <Custom v-if="widget.name === 'custom'" :widget="widget" @forceUpdate="$forceUpdate"/>
        </div>
      </template>
    </draggable>
  </div>
</template>

<script>
import draggable from "vuedraggable";
import axios from "axios";
import Custom from "@/components/Custom";

export default {
  name: 'App',
  props: {
    programmeFilter: Number,
    displayDescription: Number,
  },
  components: {
    Custom,
    draggable
  },
  data() {
    return {
      programmes: [],
      selectedProgramme: null,
      widgets: [],
      colors: "",
      translations:{
        all: "",
        filterByProgram: "",
      },
      status: null,
      enableDrag: false,
      data: {
        label: "",
        description: "",
      },
    }
  },
  created() {
    this.getTranslations();
    this.getWidgets();
    this.getPaletteColors();
    this.getProfileLabel();
    if(this.programmeFilter == 1){
      this.getProgrammes();
    }
  },
  methods: {
    getTranslations() {
      this.translations = {
        all: this.translate("COM_EMUNDUS_DASHBOARD_ALL_PROGRAMMES"),
        filterByProgram: this.translate("COM_EMUNDUS_DASHBOARD_FILTER_BY_PROGRAMMES"),
        profilArea: this.translate("ok "),
      };
    },
    getWidgets(){
      axios({
        method: "get",
        url: "index.php?option=com_emundus&controller=dashboard&task=getwidgets",
      }).then(response => {
        this.widgets = response.data.data;
      });
    },

    getPaletteColors(){
      axios({
        method: "get",
        url: "index.php?option=com_emundus&controller=dashboard&task=getpalettecolors",
      }).then(response => {
        this.colors = response.data.data;
      });
    },

    getProgrammes(){
      axios({
        method: "get",
        url: "index.php?option=com_emundus&controller=program&task=getallprogram",
      }).then(response => {
        this.programmes = response.data.data;
      });
    },

    getProfileLabel(){
      let url = window.location.origin+'/index.php?option=com_emundus&controller=users&task=getcurrentprofile';
      fetch(url, {
        method: 'GET',
      }).then((response) => {

         if (response.ok) {
          return response.json();
        }
      }).then((result) => {
        if(result.status) {
          this.data = {
            label: result.data.label,
            description: result.data.description,
          };
        }
      });
    },

  }
}
</script>

<style scoped>
span#profile_label {
  color: var(--em-default-title-color-1);
  font-family: var(--em-applicant-font-title);
  font-size: var(--em-coordinator-h1);
  font-style: normal;
  line-height: 28.8px;
  font-weight: 500;
}


#app > div{
  display: flex;
  flex-wrap: wrap;
  flex-direction: row;
}

#app > div > div{
  width: 100%;
  margin: 0 0 30px 0;
}

.tchooz-widget{
  height: 400px;
}

.cta-block{
  position: absolute;
  right: 20px;
  top: 30px;
  color: #b0b0bf;
}
.pointer{
  cursor: pointer;
}
.jello-horizontal {
  -webkit-animation: vibrate-1 1s infinite;
  animation: vibrate-1 1s infinite;
}
/* ----------------------------------------------
 * Generated by Animista on 2020-12-24 16:21:1
 * Licensed under FreeBSD License.
 * See http://animista.net/license for more info.
 * w: http://animista.net, t: @cssanimista
 * ---------------------------------------------- */

/**
 * ----------------------------------------
 * animation vibrate-1
 * ----------------------------------------
 */
@-webkit-keyframes vibrate-1 {
  0% {
    -webkit-transform: translate(0);
    transform: translate(0);
  }
  20% {
    -webkit-transform: translate(-2px, 2px);
    transform: translate(-2px, 2px);
  }
  40% {
    -webkit-transform: translate(-2px, -2px);
    transform: translate(-2px, -2px);
  }
  60% {
    -webkit-transform: translate(2px, 2px);
    transform: translate(2px, 2px);
  }
  80% {
    -webkit-transform: translate(2px, -2px);
    transform: translate(2px, -2px);
  }
  100% {
    -webkit-transform: translate(0);
    transform: translate(0);
  }
}
@keyframes vibrate-1 {
  0% {
    -webkit-transform: translate(0);
    transform: translate(0);
  }
  20% {
    -webkit-transform: translate(-2px, 2px);
    transform: translate(-2px, 2px);
  }
  40% {
    -webkit-transform: translate(-2px, -2px);
    transform: translate(-2px, -2px);
  }
  60% {
    -webkit-transform: translate(2px, 2px);
    transform: translate(2px, 2px);
  }
  80% {
    -webkit-transform: translate(2px, -2px);
    transform: translate(2px, -2px);
  }
  100% {
    -webkit-transform: translate(0);
    transform: translate(0);
  }
}

/**** END ****/

.handle{
  cursor: grab;
}

.program-filter{
  text-align: center;
  margin-bottom: 10px;
}
.program-filter label{
  margin-bottom: 0 !important;
  margin-right: 10px;
}
</style>
