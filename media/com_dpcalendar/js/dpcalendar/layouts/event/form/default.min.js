function checkOverlapping(){var e=document.getElementById("dp-event-form-message-box");if(e){e.style.display="none";var t=new Url;Joomla.request({method:"post",url:"index.php?option=com_dpcalendar&task=event.overlapping",data:DPCalendar.formToString(document.getElementById("dp-event-form"),"input:not([name=task]), select")+"&id="+t.query.e_id,onSuccess:function(t){var n=JSON.parse(t);null!=n.messages&&document.getElementById("system-message-container")&&Joomla.renderMessages(n.messages),n.data.message&&(e.style.display="block",e.className="alert "+(n.data.count?"":"alert-success"),e.innerHTML=n.data.message,e.getAttribute("data-overlapping")&&(document.getElementById("dp-event-form-actions-apply").disabled=n.data.count>0,document.getElementById("dp-event-form-actions-save").disabled=n.data.count>0,document.getElementById("dp-event-form-actions-save2new").disabled=n.data.count>0,document.getElementById("dp-event-form-actions-save2copy").disabled=n.data.count>0))}})}}function updateFormFromRule(){if(null!=jQuery("#jform_rrule").val()){var e=null;jQuery.each(jQuery("#jform_rrule").val().split(";"),function(){var t=this.split("=");if(t.length>1)switch(t[0]){case"FREQ":jQuery("#jform_scheduling input").each(function(){var n=jQuery(this);t[1]==n.val()&&(n.attr("checked","checked"),"0"==t[1]||(e=n.val())),"DAILY"==t[1]&&(jQuery("#jform_scheduling_daily_weekdays0").attr("checked",null),jQuery("#jform_scheduling_daily_weekdays1").attr("checked","checked"))});break;case"BYDAY":"WEEKLY"==e&&"MO,TU,WE,TH,FR"==t[1]&&(jQuery("#jform_scheduling_daily_weekdays0").attr("checked","checked"),jQuery("#jform_scheduling_daily_weekdays1").attr("checked",null),jQuery("#jform_scheduling1").attr("checked","Checked")),jQuery.each(t[1].split(","),function(){if("MONTHLY"==e){var t=this.length,n=this.substring(t-2,t),r=this.substring(0,t-2);-1==r&&(r="last"),jQuery('#jform_scheduling_monthly_week option[value="'+r+'"]').prop("selected",!0),jQuery('#jform_scheduling_monthly_week_days option[value="'+n+'"]').prop("selected",!0)}else jQuery('#jform_scheduling_weekly_days option[value="'+this+'"]').prop("selected",!0)});break;case"BYMONTHDAY":jQuery('#jform_scheduling_monthly_options input[value="by_day"]').attr("checked","checked"),jQuery.each(t[1].split(","),function(){jQuery('#jform_scheduling_monthly_days option[value="'+this+'"]').prop("selected",!0)});break;case"COUNT":jQuery("#jform_scheduling_repeat_count").val(t[1]);break;case"INTERVAL":jQuery("#jform_scheduling_interval").val(t[1]);break;case"UNTIL":var n=document.getElementById("jform_scheduling_end_date");n.value=moment.utc(t[1]).format(n.getAttribute("format"))}}),changeVisiblity()}}function updateRuleFromForm(){var e="";(jQuery("#jform_scheduling1")[0].checked&&(e="FREQ=DAILY",jQuery("#jform_scheduling_daily_weekdays0")[0].checked&&(e="FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR")),jQuery("#jform_scheduling2")[0].checked)&&(e="FREQ=WEEKLY",(t=jQuery("#jform_scheduling_weekly_days option:selected")).length>0&&(e+=";BYDAY=",t.each(function(){e+=jQuery(this).val()+","}),e=e.slice(0,-1)));if(jQuery("#jform_scheduling3")[0].checked)if(e="FREQ=MONTHLY",jQuery("#jform_scheduling_monthly_options0")[0].checked){var t;(t=jQuery("#jform_scheduling_monthly_days option:selected")).length>0&&(e+=";BYMONTHDAY=",t.each(function(){e+=jQuery(this).val()+","}),e=e.slice(0,-1))}else{var n=jQuery("#jform_scheduling_monthly_week option:selected"),r=!1;n.length>0&&(e+=";BYDAY=",n.each(function(){var t=jQuery("#jform_scheduling_monthly_week_days option:selected");if(t.length>0){var n=jQuery(this).val();"last"==n&&(n=-1),t.each(function(){e+=n+jQuery(this).val()+",",r=!0})}}),r&&(e=e.slice(0,-1)))}if(jQuery("#jform_scheduling4")[0].checked&&(e="FREQ=YEARLY"),e.length>1){var a=jQuery("#jform_scheduling_interval").val();a>0&&(e+=";INTERVAL="+a);var d=jQuery("#jform_scheduling_repeat_count").val();d>0&&(e+=";COUNT="+d);var i=document.getElementById("jform_scheduling_end_date"),o=moment(i.value,i.getAttribute("format"));o.isValid()&&(e+=";UNTIL="+o.format("YYYYMMDD")+"T235900Z")}jQuery("#jform_rrule").val(e)}function updateLocationFrame(){if(jQuery("#jform_rooms").length<1)jQuery("#dp-event-form-map").hide();else{jQuery("#dp-event-form-map").detach().appendTo(jQuery("#jform_rooms").parent().parent().parent());var e=document.getElementById("dp-event-form-map-frame");null!=e&&null!=e.dpmap&&(DPCalendar.Map.clearMarkers(e.dpmap),jQuery("#jform_location_ids option:selected").each(function(){var t=jQuery(this).html(),n=t.substring(t.lastIndexOf("[")+1,t.lastIndexOf("]")).split(":");n.length<2||0==n[0]&&0==n[1]||DPCalendar.Map.createMarker(e.dpmap,{latitude:n[0],longitude:n[1],title:t})}))}}function changeVisiblity(){jQuery("#jform_scheduling0")[0].checked?(jQuery(".field-scheduling_end_date").parent().hide(),jQuery(".field-scheduling_interval").parent().hide(),jQuery(".field-scheduling_repeat_count").parent().hide(),jQuery(".field-rrule").parent().hide()):(jQuery(".field-scheduling_end_date").parent().show(),jQuery(".field-scheduling_interval").parent().show(),jQuery(".field-scheduling_repeat_count").parent().show(),jQuery(".field-rrule").parent().show()),jQuery("#jform_scheduling1")[0].checked?jQuery(".field-scheduling_daily_weekdays").parent().show():jQuery(".field-scheduling_daily_weekdays").parent().hide(),jQuery("#jform_scheduling2")[0].checked?jQuery(".field-scheduling_weekly_days").parent().show():jQuery(".field-scheduling_weekly_days").parent().hide(),jQuery("#jform_scheduling3")[0].checked?(jQuery(".field-scheduling_monthly_options").parent().show(),jQuery(".field-scheduling_monthly_week").parent().show(),jQuery(".field-scheduling_monthly_week_days").parent().show(),jQuery(".field-scheduling_monthly_days").parent().show(),jQuery("#jform_scheduling_monthly_options0")[0].checked?(jQuery(".field-scheduling_monthly_week").parent().hide(),jQuery(".field-scheduling_monthly_week_days").parent().hide(),jQuery(".field-scheduling_monthly_days").parent().show()):(jQuery(".field-scheduling_monthly_week").parent().show(),jQuery(".field-scheduling_monthly_week_days").parent().show(),jQuery(".field-scheduling_monthly_days").parent().hide())):(jQuery(".field-scheduling_monthly_options").parent().hide(),jQuery(".field-scheduling_monthly_week").parent().hide(),jQuery(".field-scheduling_monthly_week_days").parent().hide(),jQuery(".field-scheduling_monthly_days").parent().hide())}jQuery(document).ready(function(){if(jQuery(".field-scheduling, #jform_scheduling_monthly_options, #jform_scheduling_daily_weekdays").bind("click",function(e){changeVisiblity(),updateRuleFromForm()}),jQuery("#jform_scheduling_end_date, #jform_scheduling_interval, #jform_scheduling_repeat_count").bind("change",function(){updateRuleFromForm()}),jQuery("#jform_scheduling_weekly_days, #jform_scheduling_monthly_days, #jform_scheduling_monthly_week_days, #jform_scheduling_monthly_week").bind("change",function(){updateRuleFromForm()}),jQuery("#jform_rrule").bind("change",function(e){updateFormFromRule()}),updateFormFromRule(),jQuery("#scheduling-expert-button").click(function(){jQuery("#scheduling-rrule").children().fadeToggle()}),jQuery("#scheduling-rrule").children().hide(),jQuery("#jform_all_day input").bind("click",function(e){0==jQuery(this).val()?jQuery("#jform_start_date_time, #jform_end_date_time").show():jQuery("#jform_start_date_time, #jform_end_date_time").hide(),checkOverlapping()}),jQuery("#jform_all_day0")[0].checked||!jQuery("#jform_all_day0")[0].checked&&!jQuery("#jform_all_day1")[0].checked?jQuery("#jform_start_date_time, #jform_end_date_time").show():jQuery("#jform_start_date_time, #jform_end_date_time").hide(),jQuery("#jform_start_date, #jform_start_date_time, #jform_end_date, #jform_end_date_time, #jform_rooms").change(function(e){setTimeout(checkOverlapping,2e3)}),jQuery("#jform_catid").bind("change",function(e){return setTimeout(checkOverlapping,2e3),!0}),jQuery("#dp-event-form-message-box").hide(),setTimeout(checkOverlapping,2e3),setTimeout(updateLocationFrame,2e3),jQuery("#dp-event-form-container-tabs-tab-content").addClass("timepair"),Joomla.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS")){jQuery(".field-scheduling .controls, #dp-event-form-container-tabs-tab-booking .controls").append('<span class="dp-event-form-free-information-text">'+Joomla.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS")+"</span>")}jQuery("#jform_location_ids").bind("change",function(e){Joomla.loadingLayer("show"),jQuery("input[name=task]").val("event.reload"),this.form.submit()}),jQuery("#dp-event-form-map-form-save").click(function(){var e={jform:{title:jQuery("#location_title").val(),country:jQuery("#location_country").val(),province:jQuery("#location_province").val(),city:jQuery("#location_city").val(),zip:jQuery("#location_zip").val(),street:jQuery("#location_street").val(),number:jQuery("#location_number").val(),state:1,language:"*"}};e[jQuery("#dp-event-form-map-form-token").val()]="1",e.ajax="1",e.id=0,jQuery.ajax({type:"POST",url:"index.php?option=com_dpcalendar&task=locationform.save",data:e,success:function(e){var t=jQuery.parseJSON(e);null!=t.data.id&&null!=t.data.display&&(jQuery("#jform_location_ids").append('<option value="'+t.data.id+'" selected="selected">'+t.data.display+"</option>"),jQuery("#jform_location_ids").trigger("liszt:updated"),updateLocationFrame(),jQuery("#dp-event-form-map-form-container input").val("")),Joomla.renderMessages(t.messages)}})});var e=jQuery("#dp-event-form-map-form");e.hide(),jQuery("#dp-event-form-map-title-toggle-up").hide();var t=jQuery("#dp-event-form-map-title-toggle");t.bind("click",function(n){e.slideToggle("slow",function(){e.is(":visible")?(t.find('i[data-direction="up"]').show(),t.find('i[data-direction="down"]').hide()):(t.find('i[data-direction="up"]').hide(),t.find('i[data-direction="down"]').show())})})});