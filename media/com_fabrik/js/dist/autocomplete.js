/*! Fabrik */

var FbAutocomplete=new Class({Implements:[Options,Events],options:{menuclass:"auto-complete-container",classes:{ul:"results",li:"result"},url:"index.php",max:10,onSelection:Class.empty,autoLoadSingleResult:!0,minTriggerChars:1,storeMatchedResultsOnly:!1},initialize:function(e,t){this.matchedResult=!1,this.setOptions(t),e=e.replace("-auto-complete",""),this.options.labelelement="null"===typeOf(document.id(e+"-auto-complete"))?document.getElement(e+"-auto-complete"):document.id(e+"-auto-complete"),this.cache={},this.selected=-1,this.mouseinsde=!1,document.addEvent("keydown",function(e){this.doWatchKeys(e)}.bind(this)),this.element="null"===typeOf(document.id(e))?document.getElement(e):document.id(e),this.buildMenu(),this.getInputElement()?(this.getInputElement().setProperty("autocomplete","off"),this.getInputElement().addEvent("keyup",function(e){this.search(e)}.bind(this)),this.getInputElement().addEvent("blur",function(e){this.options.storeMatchedResultsOnly&&(this.matchedResult||void 0!==this.data&&1===this.data.length&&this.options.autoLoadSingleResult||(this.element.value=""))}.bind(this))):fconsole("autocomplete didn't find input element")},canSearch:function(e){return!!this.isMinTriggerlength()&&("tab"!==e.key&&"enter"!==e.key||(e.stop(),this.closeMenu(),!1))},defineSearchValue:function(){var e=this.getInputElement().get("value");return""===e&&(this.element.value=""),e},search:function(e){if(this.canSearch(e)){this.matchedResult=!1;var t=this.getInputElement().get("value");if(""===t&&(this.element.value=""),t!==this.searchText&&""!==t)if(!1===this.options.storeMatchedResultsOnly&&(this.element.value=t),this.positionMenu(),this.cache[t])this.populateMenu(this.cache[t]),this.openMenu();else{this.ajax&&(this.closeMenu(),this.ajax.cancel());var i={value:t};this.ajax=this.makeAjax(this.options.url,i)}this.searchText=t}},makeAjax:function(e,t){return new Request({url:e,data:t,onRequest:function(){Fabrik.loader.start(this.getInputElement())}.bind(this),onCancel:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this),onSuccess:function(e){this.completeAjax(e,t.value)}.bind(this),onComplete:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this),onFailure:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this),onException:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this)}).send()},completeAjax:function(e,t){Fabrik.loader.stop(this.getInputElement()),e=JSON.parse(e),this.cache[t]=e,this.populateMenu(e),this.openMenu()},buildMenu:function(){this.menu=new Element("div",{class:this.options.menuclass,styles:{position:"absolute"}}).adopt(new Element("ul",{class:this.options.classes.ul})),this.menu.inject(document.body),this.menu.addEvent("mouseenter",function(){this.mouseinsde=!0}.bind(this)),this.menu.addEvent("mouseleave",function(){this.mouseinsde=!1}.bind(this))},getInputElement:function(){return this.options.labelelement?this.options.labelelement:this.element},positionMenu:function(){var e=this.getInputElement().getCoordinates();this.getInputElement().getPosition();this.menu.setStyles({left:e.left,top:e.top+e.height-1,width:e.width})},populateMenu:function(e){e.map(function(e,t){return e.text=Encoder.htmlDecode(e.text),e}),this.data=e;var t=this.getListMax(),i=this.menu.getElement("ul");i.empty(),1===e.length&&this.options.autoLoadSingleResult&&(this.matchedResult=!0,this.element.value=e[0].value,this.fireEvent("selection",[this,this.element.value]));for(var s=0;s<t;s++){var n=e[s],o=new Element("li",{"data-value":n.value,class:"unselected "+this.options.classes.li}).set("text",n.text);o.inject(i),o.addEvent("click",function(e){e.stop(),this.makeSelection(e.target)}.bind(this))}e.length>this.options.max&&new Element("li").set("text","....").inject(i)},makeSelection:function(e){"null"!==typeOf(e)?(this.getInputElement().value=e.get("text"),this.element.value=e.getProperty("data-value"),this.matchedResult=!0,this.closeMenu(),this.fireEvent("selection",[this,this.element.value]),this.element.fireEvent("change",new Event.Mock(this.element,"change"),700),Fabrik.fireEvent("fabrik.autocomplete.selected",[this,this.element.value])):Fabrik.fireEvent("fabrik.autocomplete.notselected",[this,this.element.value])},closeMenu:function(){this.shown&&(this.shown=!1,this.menu.fade("out"),this.selected=-1,document.removeEvent("click",function(e){this.doTestMenuClose(e)}.bind(this)))},openMenu:function(){this.shown||this.isMinTriggerlength()&&(this.shown=!0,this.menu.setStyle("visibility","visible").fade("in"),document.addEvent("click",function(e){this.doTestMenuClose(e)}.bind(this)),this.selected=0,this.highlight())},doTestMenuClose:function(){this.mouseinsde||this.closeMenu()},isMinTriggerlength:function(){return this.getInputElement().get("value").length>=this.options.minTriggerChars},getListMax:function(){return"null"===typeOf(this.data)?0:this.data.length>this.options.max?this.options.max:this.data.length},doWatchKeys:function(e){if(document.activeElement===this.getInputElement()){Fabrik.loader.stop(this.getInputElement());var t=this.getListMax();if(this.shown)if(this.isMinTriggerlength())switch("enter"!==e.key&&"tab"!==e.key||window.fireEvent("blur"),e.code){case 40:this.shown||this.openMenu(),this.selected+1<t&&(this.selected++,this.highlight()),e.stop();break;case 38:-1<=this.selected-1&&(this.selected--,this.highlight()),e.stop();break;case 13:case 9:e.stop();var i=new Event.Mock(this.getSelected(),"click");this.makeSelection(i);break;case 27:e.stop(),this.matchedResult=!1,this.closeMenu()}else e.stop(),this.closeMenu();else 13===e.code.toInt()&&e.stop(),40===e.code.toInt()&&this.openMenu()}},getSelected:function(){return this.menu.getElements("li").filter(function(e,t){return t===this.selected}.bind(this))[0]},highlight:function(){this.matchedResult=!0,this.menu.getElements("li").each(function(e,t){t===this.selected?e.addClass("selected"):e.removeClass("selected")}.bind(this))}}),FabCddAutocomplete=new Class({Extends:FbAutocomplete,search:function(e){if(this.canSearch(e)){var t,i=this.defineSearchValue();if(i!==this.searchText&&""!==i){var s=document.id(this.options.observerid);if("null"===typeOf(s))return void this.parent(e);if(t=s.get("value")+"."+i,this.positionMenu(),this.cache[t])this.populateMenu(this.cache[t]),this.openMenu();else{this.ajax&&(this.closeMenu(),this.ajax.cancel());var n=document.id(this.options.observerid).get("value");"null"===typeOf(n)&&(n=Fabrik.getBlock(this.options.formRef).elements.get(this.options.observerid).get("value"));var o={value:i,fabrik_cascade_ajax_update:1,v:n};this.ajax=this.makeAjax(this.options.url,o)}}this.searchText=i}}});