/*! Fabrik */

define(["jquery","fab/element"],function(a,e){return window.FbFileElement=new Class({Extends:e,ajaxFolder:function(){var i=this;if(this.folderlist=[],null!==this.element){var e=a(this.element.getParent(".fabrikElement"));this.breadcrumbs=e.find(".breadcrumbs"),this.folderdiv=e.find(".folderselect"),a(this.folderdiv).slideUp({duration:0}),this.hiddenField=e.find(".folderpath")[0],e.find(".toggle").on("click",function(e){e.preventDefault(),a(i.folderdiv).slideToggle()}),this.watchAjaxFolderLinks()}},watchAjaxFolderLinks:function(){var i=this;this.folderdiv.find("a").on("click",function(e){e.preventDefault(),i.browseFolders(a(this))}),this.breadcrumbs.find("a").on("click",function(e){e.preventDefault(),i.useBreadcrumbs(a(this))})},browseFolders:function(e){this.folderlist.push(e.text());var i=this.options.dir+this.folderlist.join(this.options.ds);this.addCrumb(e.text()),this.doAjaxBrowse(i)},useBreadcrumbs:function(e){var i,t,s,d,r,n=this,l=e[0].className;if(this.folderlist=[],""!==l)for(t=parseInt(l.replace("crumb",""),10),s=1;s<=t;s++)d=a(this.breadcrumbs.find("a")[s]),n.folderlist.push(a(d).html());r=[this.breadcrumbs.find("a")[0].clone(),this.breadcrumbs.find("span")[0].clone()],delete this.breadcrumbs.find("a")[0],delete this.breadcrumbs.find("span")[0],this.breadcrumbs.empty(),this.breadcrumbs.append(r),this.folderlist.each(function(e){n.addCrumb(e)}),i=this.options.dir+this.folderlist.join(this.options.ds),this.doAjaxBrowse(i)},doAjaxBrowse:function(e){var t=this;a.ajax({url:"",data:{dir:e,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"fileupload",method:"ajax_getFolders",element_id:this.options.id}}).done(function(e){e=JSON.parse(e),t.folderdiv.empty(),e.each(function(e){var i=a('<li class="fileupload_folder"><a href="#">'+e+"</a>");t.folderdiv.append(i)}),0===e.length?a(t.folderdiv).slideUp({duration:0}):a(t.folderdiv).slideUp(),t.watchAjaxFolderLinks(),a(t.hiddenField).val("/"+t.folderlist.join("/")+"/"),t.fireEvent("onBrowse")})},addCrumb:function(e){this.breadcrumbs.append(a('<a href="#" class="crumb'+this.folderlist.length+'">'+e+"</a>"),a("<span> / </span>"))}}),window.FbFileElement});