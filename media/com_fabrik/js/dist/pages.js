/*! Fabrik */

var Pages=new Class({initialize:function(e,t){this.editable=t,document.addEvent("mousedown",function(e){this.clearActive(e)}.bind(this)),Fabrik.addEvent("fabrik.page.add",function(e){this.makeActive(e)}.bind(this)),this.pages=$H({}),this.activePage=null,this.container=document.id(e),Fabrik.addEvent("fabrik.tab.add",function(e){this.add(e)}.bind(this)),Fabrik.addEvent("fabrik.tab.click",function(e){this.show(e)}.bind(this)),Fabrik.addEvent("fabrik.tab.remove",function(e){this.remove(e)}.bind(this)),Fabrik.addEvent("fabrik.keynav",function(e){this.moveItem(e)}.bind(this)),Fabrik.addEvent("fabrik.inline.save",function(e){this.updateTabKey(e)}.bind(this))},makeActive:function(e){this.clearActive(),e.addClass("active"),this.active=e;var t=document.getElements(".itemPlaceHolder").getStyle("z-index").sort().getLast().toInt()+1;document.getElements(".itemPlaceHolder").each(function(e){e.setStyle("zindex",e.getStyle("z-index").toInt()-1)}),e.setStyle("z-index",t)},clearActive:function(){delete this.active,document.getElements(".itemPlaceHolder").removeClass("active")},moveItem:function(e,t){if(this.active&&this.editable){t=t?10:0;var i=this.active.getCoordinates(this.getActivePage().page);switch(e){case 37:this.active.setStyle("left",i.left-2-t);break;case 38:this.active.setStyle("top",i.top-2-t);break;case 39:this.active.setStyle("left",i.left+1+t);break;case 40:this.active.setStyle("top",i.top+1+t)}}},add:function(e,t){var i=new Page(t,this.editable);this.container.adopt(i.page),i.show(),this.pages[t]=i,this.show()},remove:function(e,t){t=t.retrieve("ref"),delete this.pages.t,this.pages.erase(t)},show:function(t){this.pages.each(function(e){e.hide()});try{this.pages[t].show(),this.activePage=t}catch(e){var i=this.pages.getKeys();0<i.length&&(t=i[0],this.pages[t].show(),this.activePage=t)}},getHTMLPages:function(){var t=[];return this.pages.each(function(e){t.push(e.page)}),t},getActivePage:function(){return this.activePage||(this.activePage=0),this.pages[this.activePage]},fromJSON:function(e){$H(e).each(function(e,i){this.pages[i]&&$H(e).each(function(e,t){this.pages[i].insert(e.id,e.label,e.type,e.dimensions)}.bind(this))}.bind(this))},toJSON:function(){var t={};return this.pages.each(function(a,e){var s={};a.page.getElements(".itemPlaceHolder").each(function(e){a.page.show();var t=e.id.split("_")[0],i=e.getElement(".handlelabel").get("text");s[e.id]={dimensions:e.getCoordinates(a.page),label:i,type:t,id:e.id}}),t[e.trim()]=s}),t},updateTabKey:function(e){var t=e.retrieve("origValue").trim(),i=this.pages[t];this.pages[e.get("text").trim()]=i,delete this.pages[t],this.pages.erase(t)}});Page=new Class({initialize:function(e,t){this.editable=t,this.page=new Element("div",{class:"page",styles:{display:"none"}}),this.editable&&(Fabrik.addEvent("fabrik.item.resized",function(e){this.saveCoords(e)}.bind(this)),Fabrik.addEvent("fabrik.item.moved",function(e){this.saveCoords(e)}.bind(this)))},show:function(){this.page.show()},hide:function(){this.page.hide()},remove:function(){this.page.destroy()},removeItem:function(e,t){e.stop(),confirm("Do you really want to delete")&&(document.id(t).destroy(),Fabrik.fireEvent("fabrik.page.block.delete",[t]))},insert:function(e,t,i,a){Fabrik.fireEvent("fabrik.page.insert",[this,e,t,i,a])},saveCoords:function(e){}});