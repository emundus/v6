/*! Fabrik */

define(["jquery"],function(jQuery){return window.FbElement=new Class({Implements:[Events,Options],options:{element:null,defaultVal:"",value:"",label:"",editable:!1,isJoin:!1,joinId:0,changeEvent:"change",hasAjaxValidation:!1},initialize:function(e,t){var i=this;if(this.setPlugin(""),t.element=e,this.strElement=e,this.loadEvents=[],this.events=$H({}),this.setOptions(t),this.options.advanced){var n=this.getChangeEvent();jQuery("#"+this.options.element).on("change",{changeEvent:n},function(e){document.id(this.id).fireEvent(e.data.changeEvent,new Event.Mock(document.id(this.id),e.data.changeEvent))})}return Fabrik.on("fabrik.form.element.added",function(e,t,n){n===i&&i.addNewEvent(i.getFocusEvent(),function(){i.removeTipMsg()})}),this.setElement()},destroy:function(){},setPlugin:function(e){"null"!==typeOf(this.plugin)&&""!==this.plugin||(this.plugin=e)},getPlugin:function(){return this.plugin},setElement:function(){return!!document.id(this.options.element)&&(this.element=document.id(this.options.element),this.setorigId(),!0)},get:function(e){if("value"===e)return this.getValue()},getFormElementsKey:function(e){return this.baseElementId=e},attachedToForm:function(){this.setElement(),Fabrik.bootstrapped?(this.alertImage=new Element("i."+this.form.options.images.alert),this.successImage=new Element("i.icon-checkmark",{styles:{color:"green"}})):(this.alertImage=new Asset.image(this.form.options.images.alert),this.alertImage.setStyle("cursor","pointer"),this.successImage=new Asset.image(this.form.options.images.action_check)),jQuery(this.form.options.images.ajax_loader).data("isicon")?this.loadingImage=new Element("span").set("html",this.form.options.images.ajax_loader):this.loadingImage=new Asset.image(this.form.options.images.ajax_loader),this.form.addMustValidate(this)},fireEvents:function(e){this.hasSubElements()?this._getSubElements().each(function(t){Array.mfrom(e).each(function(e){t.fireEvent(e)}.bind(this))}.bind(this)):Array.mfrom(e).each(function(e){this.element&&this.element.fireEvent(e)}.bind(this))},getElement:function(){return"null"===typeOf(this.element)&&(this.element=document.id(this.options.element)),this.element},_getSubElements:function(){var e=this.getElement();return"null"!==typeOf(e)&&(this.subElements=e.getElements(".fabrikinput"),this.subElements)},hasSubElements:function(){return this._getSubElements(),("array"===typeOf(this.subElements)||"elements"===typeOf(this.subElements))&&0<this.subElements.length},unclonableProperties:function(){return["form"]},cloneUpdateIds:function(e){this.element=document.id(e),this.options.element=e},runLoadEvent:function(js,delay){delay=delay||0,"function"===typeOf(js)?js.delay(delay):0===delay?eval(js):function(){console.log("delayed calling runLoadEvent for "+delay),eval(js)}.bind(this).delay(delay)},removeCustomEvents:function(){},renewEvents:function(){this.events.each(function(e,t){this.element.removeEvents(t),e.each(function(e){this.addNewEventAux(t,e)}.bind(this))}.bind(this))},addNewEventAux:function(action,js){this.element.addEvent(action,function(e){"function"===typeOf(js)?js.delay(0,this,this):eval(js)}.bind(this))},addNewEvent:function(e,t){"load"===e?(this.loadEvents.push(t),this.runLoadEvent(t)):(this.element||(this.element=document.id(this.strElement)),this.element&&(Object.keys(this.events).contains(e)||(this.events[e]=[]),this.events[e].push(t),this.addNewEventAux(e,t)))},addEvent:function(e,t){this.addNewEvent(e,t)},validate:function(){},addAjaxValidationAux:function(){var t=this;if(this.element&&this.options.hasAjaxValidation){var e=jQuery(this.element);if(e.hasClass("fabrikSubElementContainer"))return void e.find(".fabrikinput").on(this.getChangeEvent(),function(e){t.form.doElementValidation(e,!0)});e.on(this.getChangeEvent(),function(e){t.form.doElementValidation(e,!1)})}},addAjaxValidation:function(){this.element||(this.element=document.id(this.strElement)),this.element&&(this.options.hasAjaxValidation=!0,this.addAjaxValidationAux())},addNewOption:function(e,t){var n,i=document.id(this.options.element+"_additions").value,s={val:e,label:t};(n=""!==i?JSON.parse(i):[]).push(s);for(var a="[",o=0;o<n.length;o++)a+=JSON.stringify(n[o])+",";a=a.substring(0,a.length-1)+"]",document.id(this.options.element+"_additions").value=a},getLabel:function(){return this.options.label},setLabel:function(e){this.options.label=e;var t=this.getLabelElement();t&&(t[0].textContent=e)},update:function(e){this.getElement()&&(this.options.editable?this.element.value=e:this.element.innerHTML=e)},updateByLabel:function(e){this.update(e)},set:function(e){this.update(e)},getValue:function(){return!!this.element&&(this.options.editable?this.element.value:this.options.value)},reset:function(){!0===this.options.editable&&this.update(this.options.defaultVal),this.resetEvents()},resetEvents:function(){this.loadEvents.each(function(e){this.runLoadEvent(e,100)}.bind(this))},clear:function(){this.update("")},onsubmit:function(e){e&&e(!0)},afterAjaxValidation:function(){},shouldAjaxValidate:function(){return!0},cloned:function(e){this.renewEvents(),this.resetEvents(),this.addAjaxValidationAux();var t=this.getChangeEvent();this.element.hasClass("chzn-done")&&(this.element.removeClass("chzn-done"),this.element.addClass("chzn-select"),this.element.getParent().getElement(".chzn-container").destroy(),jQuery("#"+this.element.id).chosen(),jQuery(this.element).addClass("chzn-done"),jQuery("#"+this.options.element).on("change",{changeEvent:t},function(e){document.id(this.id).fireEvent(e.data.changeEvent,new Event.Mock(e.data.changeEvent,document.id(this.id)))}))},decloned:function(e){this.form.removeMustValidate(this)},getContainer:function(){var e=jQuery(this.element).closest(".fabrikElementContainer");return e=0!==e.length&&e[0],"null"!==typeOf(this.element)&&e},getErrorElement:function(){return this.getContainer().getElements(".fabrikErrorMessage")},getLabelElement:function(){return this.getContainer().getElements(".fabrikLabel")},getValidationFx:function(){return this.validationFX||(this.validationFX=new Fx.Morph(this.getErrorElement()[0],{duration:500,wait:!0})),this.validationFX},tips:function(){var n=this;return jQuery(Fabrik.tips.elements).filter(function(e,t){if(t===n.getContainer()||t.getParent()===n.getContainer())return!0})},addTipMsg:function(e,t){t=t||"error";var n,i,s,a,o=this.tips();if(0!==o.length){void 0===(o=jQuery(o[0])).attr(t)&&(o.attr(t,e),n=this._tipContent(o,!1),(i=jQuery("<div>")).html(n.html()),(s=jQuery("<li>").addClass(t)).html(e),jQuery("<i>").addClass(this.form.options.images.alert).prependTo(s),0===i.find('li:contains("'+jQuery(e).text()+'")').length&&i.find("ul").append(s),a=unescape(i.html()),void 0===o.data("fabrik-tip-orig")&&o.data("fabrik-tip-orig",n.html()),this._recreateTip(o,a));try{o.data("popover").show()}catch(e){o.popover("show")}}},_recreateTip:function(t,n){try{t.data("content",n),t.data("popover").setContent(),t.data("popover").options.content=n}catch(e){t.attr("data-content",n),t.popover("show")}},_tipContent:function(t,n){var i;try{t.data("popover").show(),i=t.data("popover").tip().find(".popover-content")}catch(e){i=void 0!==t.data("fabrik-tip-orig")&&n?jQuery("<div>").append(jQuery(t.data("fabrik-tip-orig"))):jQuery("<div>").append(jQuery(t.data("content")))}return i},removeTipMsg:function(){var e,t=t||"error",n=this.tips();if(void 0!==(n=jQuery(n[0])).attr(t)){e=this._tipContent(n,!0),this._recreateTip(n,e.html()),n.removeAttr(t);try{n.data("popover").hide()}catch(e){n.popover("hide")}}},moveTip:function(e,t){var n,i,s,a=this.tips();0<a.length&&(s=(a=jQuery(a[0])).data("popover"))&&(n=s.$tip)&&(void 0===(i=n.data("origPos"))&&(i={top:parseInt(a.data("popover").$tip.css("top"),10)+e,left:parseInt(a.data("popover").$tip.css("left"),10)+t},n.data("origPos",i)),n.css({top:i.top-e,left:i.left-t}))},setErrorMessage:function(e,t){var n,i,s=["fabrikValidating","fabrikError","fabrikSuccess"],a=this.getContainer();if(!1!==a){s.each(function(e){t===e?a.addClass(e):a.removeClass(e)});var o=this.getErrorElement();switch(o.each(function(e){e.empty()}),t){case"fabrikError":Fabrik.loader.stop(this.element);var r=this.tips();if(Fabrik.bootstrapped&&0!==r.length?this.addTipMsg(e):(n=new Element("a",{href:"#",title:e,events:{click:function(e){e.stop()}}}).adopt(this.alertImage),Fabrik.tips.attach(n)),o[0].adopt(n),a.removeClass("success").removeClass("info").addClass("error"),a.addClass("has-error").removeClass("has-success"),1<o.length)for(i=1;i<o.length;i++)o[i].set("html",e);var l=this.getTabDiv();if(l){var h=this.getTab(l);h&&h.addClass("fabrikErrorGroup")}break;case"fabrikSuccess":if(a.addClass("success").removeClass("info").removeClass("error"),a.addClass("has-success").removeClass("has-error"),Fabrik.bootstrapped)Fabrik.loader.stop(this.element),this.removeTipMsg();else{o[0].adopt(this.successImage);(function(){o[0].addClass("fabrikHide"),a.removeClass("success")}).delay(700)}break;case"fabrikValidating":a.removeClass("success").addClass("info").removeClass("error"),Fabrik.loader.start(this.element,e)}this.getErrorElement().removeClass("fabrikHide");var d=this.form;"fabrikError"!==t&&"fabrikSuccess"!==t||d.updateMainError();var u=this.getValidationFx();switch(t){case"fabrikValidating":case"fabrikError":u.start({opacity:1});break;case"fabrikSuccess":u.start({opacity:1}).chain(function(){a.hasClass("fabrikSuccess")&&(a.removeClass("fabrikSuccess"),this.start.delay(700,this,{opacity:0,onComplete:function(){a.addClass("success").removeClass("error"),d.updateMainError(),s.each(function(e){a.removeClass(e)})}}))})}}else console.log("Notice: couldn not set error msg for "+e+" no container class found")},setorigId:function(){if(this.options.inRepeatGroup){var e=this.options.element;this.origId=e.substring(0,e.length-1-this.options.repeatCounter.toString().length)}},decreaseName:function(t){var e=this.getElement();return"null"!==typeOf(e)&&(this.hasSubElements()?this._getSubElements().each(function(e){e.name=this._decreaseName(e.name,t),e.id=this._decreaseId(e.id,t)}.bind(this)):"null"!==typeOf(this.element.name)&&(this.element.name=this._decreaseName(this.element.name,t)),"null"!==typeOf(this.element.id)&&(this.element.id=this._decreaseId(this.element.id,t)),this.options.repeatCounter>t&&this.options.repeatCounter--,this.element.id)},_decreaseId:function(e,t,n){var i=!1;!1!==(n=n||!1)&&e.contains(n)&&(e=e.replace(n,""),i=!0);var s=Array.mfrom(e.split("_")),a=s.getLast();if("null"===typeOf(a.toInt()))return s.join("_");1<=a&&t<a&&a--,s.splice(s.length-1,1,a);var o=s.join("_");return i&&(o+=n),this.options.element=o},_decreaseName:function(e,t,n){var i=!1;!1!==(n=n||!1)&&e.contains(n)&&(e=e.replace(n,""),i=!0);var s=e.split("["),a=s[1].replace("]","").toInt();1<=a&&t<a&&a--,a+="]",s[1]=a;var o=s.join("[");return i&&(o+=n),o},setContainerRepeatNum:function(e,t){var n=this.getContainer();jQuery(n).removeClass("fb_el_"+this.origId+"_"+e),jQuery(n).addClass("fb_el_"+this.origId+"_"+t)},setName:function(t){var e=this.getElement();return"null"!==typeOf(e)&&(this.hasSubElements()?this._getSubElements().each(function(e){e.name=this._setName(e.name,t),e.id=this._setId(e.id,t)}.bind(this)):"null"!==typeOf(this.element.name)&&(this.element.name=this._setName(this.element.name,t)),"null"!==typeOf(this.element.id)&&(this.element.id=this._setId(this.element.id,t)),this.setContainerRepeatNum(this.options.repeatCounter,t),this.options.repeatCounter=t,this.element.id)},_setId:function(e,t,n){var i=!1,s="";if(!1!==(n=n||!1)){var a=new RegExp(n);e.test(a)&&(s=e.match(a)[0],e=e.replace(a,""),i=!0)}var o=Array.mfrom(e.split("_")),r=o.getLast();if("null"===typeOf(r.toInt()))return e+s;if(r.toInt()===t)return e+s;r=t,o.splice(o.length-1,1,r);var l=o.join("_");return i&&(l+=s),this.options.element=l},_setName:function(e,t,n){var i=!1,s="";if(!1!==(n=n||!1)){var a=new RegExp(n);e.test(a)&&(s=e.match(a)[0],e=e.replace(a,""),i=!0)}var o=e.split("["),r=o[1].replace("]","").toInt();if(r.toInt()===t)return e+s;r=t,r+="]",o[1]=r;var l=o.join("[");return i&&(l+=s),l},getRepeatNum:function(){return!1!==this.options.inRepeatGroup&&this.element.id.split("_").getLast()},getBlurEvent:function(){return"select"===this.element.get("tag")?"change":"blur"},getFocusEvent:function(){return"select"===this.element.get("tag")?"click":"focus"},getChangeEvent:function(){return this.options.changeEvent},select:function(){},focus:function(){this.removeTipMsg()},hide:function(){var e=this.getContainer();e&&(jQuery(e).hide(),jQuery(e).addClass("fabrikHide"))},show:function(){var e=this.getContainer();e&&(jQuery(e).show(),jQuery(e).removeClass("fabrikHide"))},toggle:function(){var e=this.getContainer();e&&e.toggle()},getCloneName:function(){return this.options.element},doTab:function(e){(function(){this.redraw(),Fabrik.bootstrapped||this.options.tab_dt.removeEvent("click",function(e){this.doTab(e)}.bind(this))}).bind(this).delay(500)},getTab:function(e){var t;Fabrik.bootstrapped?t=jQuery("a[href$=#"+e.id+"]").closest("[data-role=fabrik_tab]"):t=e.getPrevious(".tabs");return t||!1},getTabDiv:function(){var e=Fabrik.bootstrapped?".tab-pane":".current",t=this.element.getParent(e);return t||!1},watchTab:function(){var e,t=Fabrik.bootstrapped?".tab-pane":".current",n=this.element.getParent(t);n&&(Fabrik.bootstrapped?(e=document.getElement("a[href$=#"+n.id+"]").getParent("ul.nav")).addEvent("click:relay(a)",function(e,t){this.doTab(e)}.bind(this)):(e=n.getPrevious(".tabs"))&&(this.options.tab_dd=this.element.getParent(".fabrikGroup"),"none"===this.options.tab_dd.style.getPropertyValue("display")&&(this.options.tab_dt=e.getElementById("group"+this.groupid+"_tab"),this.options.tab_dt&&this.options.tab_dt.addEvent("click",function(e){this.doTab(e)}.bind(this)))))},updateUsingRaw:function(){return!1}}),window.FbElement});