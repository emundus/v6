define(["jquery","fab/loader","fab/requestqueue"],(function(e,t,o){var i=e(document);document.addEvent("click:relay(.popover button.close)",(function(t,o){var i="#"+o.get("data-popover"),n=document.getElement(i);e(i).popover("hide"),"null"!==typeOf(n)&&"input"===n.get("tag")&&(n.checked=!1)}));var n={events:{},bootstrapVersion:function(t){var o,i=[t||"modal","tooltip"],n=i.length;for(o=0;o<n;++o){var a=e.fn[i[o]];if(a){if(a.VERSION)return a.VERSION.match(/(\d+)\./)[0].toInt();if(a.Constructor&&a.Constructor.VERSION)return a.Constructor.VERSION.match(/(\d+)\./)[0].toInt()}}return 2},Windows:{}};return n.loader=new t,n.blocks={},n.periodicals={},n.addBlock=function(e,t){n.blocks[e]=t,n.fireEvent("fabrik.block.added",[t,e])},n.getBlock=function(e,t,o){return(o=o||!1)&&(n.periodicals[e]=n._getBlock.periodical(500,this,[e,t,o])),n._getBlock(e,t,o)},n._getBlock=function(e,t,o){var i;if(t=t||!1,void 0!==n.blocks[e])i=e;else{if(t)return!1;var a=Object.keys(n.blocks),r=a.searchFor(e);if(-1===r)return!1;i=a[r]}return o&&(clearInterval(n.periodicals[e]),o(n.blocks[i])),n.blocks[i]},i.on("click",".fabrik_delete a, .fabrik_action a.delete, .btn.delete",(function(e){e.rightClick||n.watchDelete(e,this)})),i.on("click",".fabrik_edit a, a.fabrik_edit",(function(e){e.rightClick||n.watchEdit(e,this)})),i.on("click",".fabrik_view a, a.fabrik_view",(function(e){e.rightClick||n.watchView(e,this)})),document.addEvent("click:relay(*[data-fabrik-view])",(function(e,t){if(!e.rightClick){var o,i,a;e.preventDefault(),o=(i="a"===e.target.get("tag")?e.target:"null"!==typeOf(e.target.getElement("a"))?e.target.getElement("a"):e.target.getParent("a")).get("href"),o+=o.contains("?")?"&tmpl=component&ajax=1":"?tmpl=component&ajax=1",o+="&format=partial",$H(n.Windows).each((function(e,t){e.close()})),(a=i.get("title"))||(a=Joomla.JText._("COM_FABRIK_VIEW"));var r={id:"view."+o,title:a,loadMethod:"xhr",contentURL:o};n.getWindow(r)}})),n.removeEvent=function(e,t){if(n.events[e]){var o=n.events[e].indexOf(t);-1!==o&&delete n.events[e][o]}},n.addEvent=n.on=function(e,t){n.events[e]||(n.events[e]=[]),n.events[e].contains(t)||n.events[e].push(t)},n.addEvents=function(e){var t;for(t in e)e.hasOwnProperty(t)&&n.addEvent(t,e[t]);return this},n.fireEvent=n.trigger=function(e,t,o){var i=n.events;return this.eventResults=[],i&&i[e]?(t=Array.mfrom(t),i[e].each((function(e){o?this.eventResults.push(e.delay(o,this,t)):this.eventResults.push(e.apply(this,t))}),this),this):this},n.requestQueue=new o,n.cbQueue={google:[]},n.loadGoogleMap=function(e,t,o){var i=("https:"===document.location.protocol?"https:":"http:")+"//maps.googleapis.com/maps/api/js?libraries=places,visualization&callback=Fabrik.mapCb";if(!1!==e&&(i+="&key="+e),""!==o&&(i+="&language="+o),0===Array.mfrom(document.scripts).filter((function(e){return e.src===i})).length){var a=document.createElement("script");a.type="text/javascript",a.src=i,document.body.appendChild(a),n.cbQueue.google.push(t)}else n.googleMap?window[t]():n.cbQueue.google.push(t)},n.mapCb=function(){var e,t;for(n.googleMap=!0,t=0;t<n.cbQueue.google.length;t++)e=n.cbQueue.google[t],"function"===typeOf(e)?e():window[e]();n.cbQueue.google=[]},n.watchDelete=function(e,t){var o,i,a;if((a=e.target.getParent(".fabrik_row"))||(a=n.activeRow),a){var r=a.getElement("input[type=checkbox][name*=id]");"null"!==typeOf(r)&&(r.checked=!0),i=(i=a.id.split("_")).splice(0,i.length-2).join("_"),o=n.blocks[i]}else if(i=e.target.getParent(".fabrikList"),"null"!==typeOf(i))i=i.id,o=n.blocks[i];else{var l=t.getParent(".floating-tip-wrapper");if(l)i=l.retrieve("list").id;else i=t.get("data-listRef");void 0===(o=n.blocks[i])||"floating"!==o.options.actionMethod||this.bootstrapped||o.form.getElements("input[type=checkbox][name*=id], input[type=checkbox][name=checkAll]").each((function(e){e.checked=!0}))}o.submit("list.delete")||e.preventDefault()},n.watchEdit=function(e,t){n.openSingleView("form",e,t)},n.watchView=function(e,t){n.openSingleView("details",e,t)},n.openSingleView=function(t,o,i){var a,r,l,c,s,p,d,f=e(i).data("list"),u=n.blocks[f];if(1===e(i).data("isajax")){if(u){if(!u.options.ajax_links)return;if(!(p=u.getActiveRow(o))||0===p.length)return;u.setActive(p),s=p.prop("id").split("_").pop()}else s=e(i).data("rowid");o.preventDefault(),a=(l="A"===e(o.target).prop("tagName")?e(o.target):e(o.target).find("a").length>0?e(o.target).find("a"):e(o.target).closest("a")).prop("href"),1!==e(i).data("iscustom")&&(a+=a.contains("?")?"&tmpl=component&ajax=1":"?tmpl=component&ajax=1",a+="&format=partial"),c=l.prop("title"),void 0===(r=l.data("loadmethod"))&&(r="xhr"),e.each(n.Windows,(function(e,t){t.close()})),d={modalId:"ajax_links",id:f+"."+s,title:c,loadMethod:r,contentURL:a,onClose:function(){var e=t+"_"+u.options.formid+"_"+s;try{n.blocks[e].destroyElements(),n.blocks[e].formElements=null,n.blocks[e]=null,delete n.blocks[e];var o="details"===t?"fabrik.list.row.view.close":"fabrik.list.row.edit.close";n.fireEvent(o,[f,s,e])}catch(e){console.log(e)}}},u&&(""!==u.options.popup_width&&(d.width=u.options.popup_width),""!==u.options.popup_height&&(d.height=u.options.popup_height),d.id="details"===t?"view."+d.id:"add."+d.id,null!==u.options.popup_offset_x&&(d.offset_x=u.options.popup_offset_x),null!==u.options.popup_offset_y&&(d.offset_y=u.options.popup_offset_y)),n.getWindow(d)}},n.timePickerClose=function(t,o){if(t){var i=e(t).closest("form");if(i.length>0&&(i=n.getBlock(i[0].id))){var a=e(t).closest(".fabrikSubElementContainer");if(a.length>0){var r=i.formElements.get(a[0].id);r&&r.hideTime(t,o)}}}},n.Array={chunk:function(e,t){var o,i,n=[];for(o=0,i=e.length;o<i;o+=t)n.push(e.slice(o,o+t));return n}},window.fireEvent("fabrik.loaded"),window.Fabrik=n,requirejs(["fab/fabrik"],(function(){n.addEvent("fabrik.form.loaded",(function(t){null!==document.getElementById("em-dimmer")&&e("#em-dimmer").remove()}))})),n}));
