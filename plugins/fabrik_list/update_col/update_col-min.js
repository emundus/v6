/*! Fabrik */

define(["jquery","fab/list-plugin"],function(t,e){var n=new Class({initialize:function(){this.updates={}},addFilter:function(t,e){this.updates[t]||(this.updates[t]=[]),this.updates[t].push(e)},onSumbit:function(){this.updates.date&&this.updates.date.each(function(t){t.onSubmit()})}});return new Class({Extends:e,initialize:function(t){if(this.parent(t),!this.options.prompt&&this.options.userSelect){var e="filter_update_col"+this.options.ref+"_"+this.options.renderOrder;Fabrik[e]=new n,this.makeUpdateColWindow()}},buttonAction:function(){if(this.options.prompt){var t=window.prompt(this.options.promptMsg,"");if(null!==t){var e=document.id("listform_"+this.options.ref);new Element("input",{type:"hidden",value:t,name:"fabrik_update_col"}).inject(e,"bottom"),this.list.submit("list.doPlugin")}}else this.options.userSelect?this.win.open():this.list.submit("list.doPlugin")},makeUpdateColWindow:function(){var o,d,l,p=this;p.windowopts={id:"update_col_win_"+p.options.ref+"_"+p.options.renderOrder,title:Joomla.JText._("PLG_LIST_UPDATE_COL_UPDATE"),loadMethod:"html",content:p.options.form,width:400,destroy:!1,height:300,onOpen:function(){this.fitToContent(!1)},onContentLoaded:function(t){var i=document.id("update_col"+p.options.ref+"_"+p.options.renderOrder);i.addEvent("click:relay(a.add)",function(t,e){var n;t.preventDefault(),"none"===(n=e.getParent("thead")?i.getElements("tbody tr").getLast():e.getParent("tr")).getStyle("display")?((o=n.getElements("td"))[0].getElement("select").selectedIndex=0,o[1].empty(),n.show()):(d=n.clone(),(o=d.getElements("td"))[0].getElement("select").selectedIndex=0,o[1].empty(),d.inject(n,"after"))}),i.addEvent("click:relay(a.delete)",function(t,e){t.preventDefault();var n=i.getElements("tbody tr");1===n.length?n.getLast().hide():e.getParent("tr").destroy()}),i.addEvent("change:relay(select.key)",function(t,e){var n=e.getParent("tbody").getElements(".update_col_elements");for(l=0;l<n.length;l++)if(n[l]!==e&&n[l].selectedIndex===e.selectedIndex)return void window.alert("This element has already been selected!");var i=e.options[e.selectedIndex],o=e.getParent("tr");Fabrik.loader.start(o);var d=o.getElement("td.update_col_value"),s=e.get("value"),a=i.get("data-plugin"),r=i.get("data-id");new Request.HTML({url:"index.php?option=com_fabrik&task=list.elementFilter&format=raw",update:d,data:{element:s,id:p.options.listid,elid:r,plugin:a,counter:0,listref:p.options.ref,context:"visualization",parentView:"update_col"+p.options.ref+"_"+p.options.renderOrder,fabrikIngoreDefaultFilterVal:1},onComplete:function(){Fabrik.loader.stop(o),p.win.fitToContent(!1)}}).send()}),i.getElement("input[type=button]").addEvent("click",function(t){t.stop(),Fabrik["filter_update_col"+p.options.ref+"_"+p.options.renderOrder].onSumbit();var e=document.id("listform_"+p.options.ref);new Element("input",{type:"hidden",value:i.toQueryString(),name:"fabrik_update_col"}).inject(e,"bottom"),p.list.submit("list.doPlugin")})}},p.win=Fabrik.getWindow(p.windowopts),p.win.close()}})});