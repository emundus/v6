define(["jquery","fab/element"],function(e,t){return window.FbInsee=new Class({Extends:t,options:{bearerToken:{},mapping:[],baseUrl:"",propertyToCheck:""},initialize:function(e,t){this.setPlugin("fabrikinsee"),this.parent(e,t);let s=document.querySelector("#"+this.element.id);s.addEventListener("paste",this.handlerPaste.bind(this)),s.addEventListener("keyup",this.handlerKeyup.bind(this)),200===this.options.bearerToken.status&&s.addEventListener("focusout",this.handlerFocusOut.bind(this)),200!==this.options.bearerToken.status&&console.log(this.options.bearerToken.message),this.options.mapping=Object.entries(this.options.mapping);let n=document.querySelector("#"+this.element.id+" input").value;""!==n&&this.callInsee(n)},select:function(){this.getElement()&&this.getElement().select()},focus:function(){this.getElement()&&this.getElement().focus(),this.parent()},cloned:function(e){this.getElement(),this.parent(e);let t=document.querySelector("#"+this.element.id);200===this.options.bearerToken.status&&t.addEventListener("focusout",this.handlerFocusOut.bind(this))},handlerPaste:function(e){e.preventDefault();let t=e.clipboardData.getData("Text");e.target.value=t.replace(/\s/g,"")},handlerKeyup:function(e){e.target.value=e.target.value.replace(/\s/g,"")},handlerFocusOut:function(e){""!==e.target.value?this.callInsee(e.target.value):this.resetFields()},resetFields:function(){let e=this.getRepeatNum();this.options.mapping.forEach(t=>{let s=t[1].insee_fabrik_element;!1!==e&&(s=s+"_"+e);this.form.elements.get(s).set("")})},callInsee:function(e){let t=this.getRepeatNum(),s=this.element.parentNode.parentNode.getElementsByClassName("fabrikErrorMessage")[0];s.innerHTML="",fetch(this.options.baseUrl+"/entreprises/sirene/V3/"+this.options.propertyToCheck+"/"+e,{method:"GET",headers:{Accept:"application/json",Authorization:this.options.bearerToken.data}}).then(e=>e.json()).then(e=>{switch(e.header.statut){case 200:this.resetFields();let n=e.etablissement;if("A"!==n.uniteLegale.etatAdministratifUniteLegale){s.innerHTML=Joomla.JText._("PLG_ELEMENT_INSEE_SIRET_CLOSED"),document.querySelector("#"+this.element.id+" input").value="";break}this.options.mapping.forEach(e=>{let s=[],i=e[1].insee_property;(i=i.split(";")).forEach(e=>{let t=n[(e=e.split(":"))[0]];e.length>1&&(t=t[e[1]]),void 0===t?s.push(e[0]):s.push(t)});let a=e[1].insee_fabrik_element;!1!==t&&(a=a+"_"+t);let r=this.form.elements.get(a),l=s.every(e=>null==e);if(!(s.length>0)||s.includes("[ND]")||l){let o=document.querySelector("#"+r.baseElementId);o.hasAttribute("readonly")&&(o.removeAttribute("readonly"),o.classList.remove("readonly"))}else if("birthday"===r.plugin||"date"===e[1].insee_property_type){let h=new Date(s.join(""));(s=[],"date"===e[1].insee_property_type)?e[1].insee_property_date_format.split("/").forEach(e=>{switch(e){case"d":10>h.getDate()?s.push("0"+h.getDate()):s.push(h.getDate());break;case"m":h.getMonth()+1<10?s.push("0"+(h.getMonth()+1)):s.push(h.getMonth()+1);break;case"Y":s.push(h.getFullYear())}}):(10>h.getDate()?s.push("0"+h.getDate()):s.push(h.getDate()),h.getMonth()+1<10?s.push("0"+(h.getMonth()+1)):s.push(h.getMonth()+1),s.push(h.getFullYear())),s=s.join("/"),r.set(s)}else if("tva"===e[1].insee_property_type){let p="",u="FR",d=parseInt(n.siren);if(null!==n.adresseEtablissement.codePaysEtrangerEtablissement&&(u=n.adresseEtablissement.codePaysEtrangerEtablissement),""!==u&&0!==d){let c=[12+3*(d%97)]%97;0!==c&&(p=u+c+d)}r.set(p)}else r.set(s.join("")),r.element.dispatchEvent(new Event(r.getChangeEvent()))});break;case 404:s.innerHTML=Joomla.JText._("PLG_ELEMENT_INSEE_SIRET_NOT_FOUND"),this.resetFields();break;case 400:s.innerHTML=e.header.message,this.resetFields();break;default:s.innerHTML=Joomla.JText._("PLG_ELEMENT_INSEE_ERROR")}})}}),window.FbInsee});