define(["jquery","fab/element"],function(e,t){return window.FbEmundusFileUploadNew=new Class({Extends:t,initialize:function(e,t){this.setPlugin("emundus_fileupload_new"),this.parent(e,t),this.watch(),document.getElementById("file_"+this.element.id).addEventListener("change",()=>{this.upload()})},cloned:function(e){console.log(e),this.getElement(),this.parent(e)},watch:function(){var e=document.querySelector("input#file_"+this.element.id);let t=e.parentElement.parentElement.parentElement,i=e.parentElement,n=new FormData;n.append("attachId",this.options.attachment_id),n.append("fnum",this.options.fnum);let l=document.createElement("div");l.setAttribute("id",this.element.id+"_attachment"),l.setAttribute("class","em-fileAttachment"),i.appendChild(l),fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload_new&method=ajax_attachment",{body:n,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(e=>{if(e.status&&(e.limitObtained?(i.querySelector("div .btn-upload").hide(),i.querySelector("input#"+this.element.id).hide(),t.querySelector(".control-label").style.cursor="default"):(i.querySelector("div .btn-upload").show(),i.querySelector("input#"+this.element.id).show(),t.querySelector(".control-label").style.cursor="pointer"),e.files)){if(i.querySelector(".em-fileAttachmentTitle"))n=i.querySelector(".em-fileAttachmentTitle");else{var n=document.createElement("span");n.setAttribute("class","em-fileAttachmentTitle em-mt-8"),n.innerText=Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_UPLOADED_FILES"),l.appendChild(n)}for(var a=0;a<e.files.length;a++){var s=document.createElement("div");if(s.setAttribute("id",this.element.id+"_attachment_link"+a),s.setAttribute("class","em-fileAttachment-link"),document.getElementById(s.id)||l.appendChild(s),1==e.files[a].can_be_viewed){var r=document.createElement("a");r.setAttribute("href",e.files[a].target),r.setAttribute("target","_blank")}else var r=document.createElement("p");var o=document.createTextNode(e.files[a].local_filename);if(s.appendChild(r),r.appendChild(o),1==e.files[a].can_be_deleted){var m=document.createElement("a");m.setAttribute("class","em-pointer em-deleteFile em-ml-8"),m.setAttribute("value",e.files[a].filename);var u=document.createElement("span");u.setAttribute("class","material-icons-outlined"),u.setAttribute("style","font-size: 16px"),u.appendChild(document.createTextNode("clear")),m.appendChild(u),s.appendChild(m),document.querySelector("#"+this.element.id+"_attachment_link"+a+" > a.em-deleteFile").addEventListener("click",()=>this.delete())}}}})},upload:function(){var e=new FormData,t=document.querySelector("input#file_"+this.element.id),i=t.parentElement,n=document.querySelector("div#"+i.id+" > a.em-deleteFile");e.append("attachId",this.options.attachment_id),e.append("elementId",this.element.id),e.append("fnum",this.options.fnum),e.append("size",this.options.size),e.append("encrypt",this.options.encrypt);for(var l=[],a=0;a<t.files.length;a++)l=t.files[a],e.append("file[]",l);fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload_new&method=ajax_upload",{body:e,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(e=>{e||Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR_TEXT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}});for(var i=0;i<e.length;i++){if(e[i].ext&&e[i].size&&!e[i].nbMax){var l=document.querySelector("input#"+this.element.id);""!==l.value&&(l.value+=","),l.setAttribute("value",l.value+e[i].upload_id),Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SUCCESS"),text:Joomla.JText._("PLG_ELEMENT_FIELD_UPLOAD"),type:"success",showConfirmButton:!1,timer:1500,customClass:{title:"em-swal-title"}})}!e[i].ext&&(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_EXTENSION"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),t.value="",n&&(n.style.display="none")),e[i].encrypt||(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ENCRYPT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),t.value=""),!e[i].size&&(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_SIZE")+e[i].maxSize,customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),t.value="",n&&(n.style.display="none")),e[i].nbMax&&(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_LIMIT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),t.value="",n&&(n.style.display="none"))}this.watch()})},delete:function(){var e=document.querySelector("input#file_"+this.element.id),t=e.parentElement,i=event.target,n=i.parentElement.parentElement.firstChild.innerText,l=i.parentElement.parentElement.firstChild.href.split("/");l=l[l.length-1],Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SURE"),html:Joomla.JText._("PLG_ELEMENT_FIELD_SURE_TEXT")+"<strong>"+n+"</strong> ?",type:"warning",showCancelButton:!0,reverseButtons:!0,confirmButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CONFIRM"),cancelButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CANCEL"),customClass:{title:"em-swal-title",cancelButton:"em-swal-cancel-button",confirmButton:"em-swal-confirm-button"}}).then(n=>{if(n.value){let a=new FormData;a.append("filename",l),a.append("attachId",this.options.attachment_id),a.append("fnum",this.options.fnum),fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload_new&method=ajax_delete",{body:a,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(n=>{if(n.status){t.querySelector("div.btn-upload").show(),e.show(),i.parentElement.parentElement.remove(),0===t.querySelectorAll(".em-fileAttachment-link").length&&document.querySelector("div#"+this.element.id+"_attachment > .em-fileAttachmentTitle").remove();var l=document.querySelector("input#"+this.element.id);if(""!==l.value){var a=l.value.split(",");a.splice(a.indexOf(n.upload_id),1),l.setAttribute("value",a.join(","))}e.value="",Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT"),type:"success",customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})}else Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_FAILED"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT_FAILED"),type:"error",customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})})}})},decreaseName:function(e){var t=this.getOrigField();return"null"!==typeOf(t)&&(t.name=this._decreaseName(t.name,e),t.id=this._decreaseId(t.id,e)),this.parent(e)},getOrigField:function(){var e=this.element.getParent(".fabrikElement"),t=e.getElement("input[name^="+this.origId+"_orig]");return"null"===typeOf(t)&&(t=e.getElement("input[id^="+this.origId+"_orig]")),t}}),window.FbEmundusFileUploadNew});