define(["jquery","fab/element"],function(e,t){return window.FbEmundusFileUploadNew=new Class({Extends:t,initialize:function(e,t){this.setPlugin("emundus_fileupload_new"),this.parent(e,t),this.watch(t.repeatCounter),document.getElementById("file_"+this.element.id).addEventListener("change",()=>{this.upload(t.repeatCounter)})},watch:function(e){var t=document.querySelector("input#file_"+this.element.id);let n=t.parentElement.parentElement.parentElement,i=t.parentElement,l=new FormData;l.append("uploads",document.getElementById(this.element.id).value),l.append("fnum",this.options.fnum),l.append("element_id",this.options.elid),l.append("attachment_id",this.options.attachment_id),l.append("repeatCounter",e);if(!document.getElementById(this.element.id+"_attachment")){let a=document.createElement("div");a.setAttribute("id",this.element.id+"_attachment"),a.setAttribute("class","em-fileAttachment"),i.appendChild(a)}fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload_new&method=ajax_attachment",{body:l,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(e=>{e.status&&(e.limitObtained?(i.querySelector("div .btn-upload").hide(),i.querySelector("input#"+this.element.id).hide(),n.querySelector(".control-label").style.cursor="default",t.hide()):(i.querySelector("div .btn-upload").show(),i.querySelector("input#"+this.element.id).show(),n.querySelector(".control-label").style.cursor="pointer",t.show()),e.files.forEach(e=>{if(null!==e.repeatCounter){var t=document.querySelector("input#"+this.element.id);""!==t.value?-1===t.value.split(",").indexOf(e.filename)&&(t.value+=",",t.setAttribute("value",t.value+e.filename)):t.setAttribute("value",e.filename)}}),this.loadFilesBlock(e.files))})},upload:function(e){var t=new FormData,n=document.querySelector("input#file_"+this.element.id);let i=n.parentElement.parentElement.parentElement;var l=n.parentElement,a=document.querySelector("div#"+l.id+" > a.em-deleteFile");t.append("attachId",this.options.attachment_id),t.append("element_id",this.options.elid),t.append("fnum",this.options.fnum),t.append("size",this.options.size),t.append("encrypt",this.options.encrypt),t.append("repeatCounter",e);for(var s=[],r=0;r<n.files.length;r++)s=n.files[r],t.append("file[]",s);fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload_new&method=ajax_upload",{body:t,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(e=>{e||Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR_TEXT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}});let t=[];for(var s=0;s<e.length;s++){if(e[s].ext&&e[s].size&&!e[s].nbMax){var r=document.querySelector("input#"+this.element.id);""!==r.value&&(r.value+=","),r.setAttribute("value",r.value+e[s].filename),Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SUCCESS"),text:Joomla.JText._("PLG_ELEMENT_FIELD_UPLOAD"),type:"success",showConfirmButton:!1,timer:1500,customClass:{title:"em-swal-title"}});let o={can_be_viewed:1,can_be_deleted:1,filename:e[s].filename,local_filename:e[s].local_filename,target:e[s].target};t.push(o)}!e[s].ext&&(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_EXTENSION"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value="",a&&(a.style.display="none")),e[s].encrypt||(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ENCRYPT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value=""),!e[s].size&&(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_SIZE")+e[s].maxSize,customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value="",a&&(a.style.display="none")),e[s].nbMax&&(Swal.fire({type:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_LIMIT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value="",a&&(a.style.display="none")),e[s].noMoreUploads&&(l.querySelector("div .btn-upload").hide(),l.querySelector("input#"+this.element.id).hide(),i.querySelector(".control-label").style.cursor="default",n.hide())}this.loadFilesBlock(t)})},delete:function(){var e=document.querySelector("input#file_"+this.element.id),t=e.parentElement,n=event.target,i=n.parentElement.parentElement.firstChild.innerText,l=n.parentElement.parentElement.firstChild.href.split("/");l=l[l.length-1],Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SURE"),html:Joomla.JText._("PLG_ELEMENT_FIELD_SURE_TEXT")+"<strong>"+i+"</strong> ?",type:"warning",showCancelButton:!0,reverseButtons:!0,confirmButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CONFIRM"),cancelButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CANCEL"),customClass:{title:"em-swal-title",cancelButton:"em-swal-cancel-button",confirmButton:"em-swal-confirm-button"}}).then(i=>{if(i.value){let a=new FormData;a.append("filename",l),a.append("attachment_id",this.options.attachment_id),a.append("fnum",this.options.fnum),a.append("element_id",this.options.elid),fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload_new&method=ajax_delete",{body:a,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(i=>{if(i.status){t.querySelector("div.btn-upload").show(),e.show(),n.parentElement.parentElement.remove(),0===t.querySelectorAll(".em-fileAttachment-link").length&&document.querySelector("div#"+this.element.id+"_attachment > .em-fileAttachmentTitle").remove();var a=document.querySelector("input#"+this.element.id);if(""!==a.value){var s=a.value.split(",");i.upload_id?s.splice(s.indexOf(i.upload_id),1):s.splice(s.indexOf(l),1),a.setAttribute("value",s.join(","))}e.value="",Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT"),type:"success",customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})}else Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_FAILED"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT_FAILED"),type:"error",customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})})}})},cloned:function(e){var t=document.getElementById(this.element.id).previousElementSibling;t&&(t.id="file_"+this.element.id);var n=document.getElementById(this.element.id).parentElement;n&&(n.id="div_"+this.element.id);var i=document.getElementById(this.element.id).nextElementSibling;i&&(i.id=this.element.id+"_attachment",i.innerHTML=""),document.getElementById("file_"+this.element.id).addEventListener("change",()=>{this.upload(e)}),this.parent(e)},loadFilesBlock:function(e){let t=document.querySelector("input#file_"+this.element.id).parentElement,n=document.getElementById(this.element.id+"_attachment");if(e.length>0){if(!t.querySelector(".em-fileAttachmentTitle")){var i=document.createElement("span");i.setAttribute("class","em-fileAttachmentTitle em-mt-8"),i.innerText=Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_UPLOADED_FILES"),n.appendChild(i)}for(var l=0;l<e.length;l++){var a=document.createElement("div");if(a.setAttribute("id",this.element.id+"_attachment_link"+l),a.setAttribute("class","em-fileAttachment-link"),n.appendChild(a),1==e[l].can_be_viewed){var s=document.createElement("a");s.setAttribute("href",e[l].target),s.setAttribute("target","_blank")}else var s=document.createElement("p");var r=document.createTextNode(e[l].local_filename);if(a.appendChild(s),s.appendChild(r),1==e[l].can_be_deleted){var o=document.createElement("a");o.setAttribute("class","em-pointer em-deleteFile em-ml-8"),o.setAttribute("value",e[l].filename);var m=document.createElement("span");m.setAttribute("class","material-icons-outlined"),m.setAttribute("style","font-size: 16px"),m.appendChild(document.createTextNode("clear")),o.appendChild(m),a.appendChild(o),document.querySelector("#"+this.element.id+"_attachment_link"+l+" > a.em-deleteFile").addEventListener("click",()=>this.delete())}}}}}),window.FbEmundusFileUploadNew});