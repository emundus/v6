/**
 * File Upload Element
 *
 * @copyright: Copyright (C) 2005-2016  Media A-Team, Inc. - All rights reserved.
 * @license: GNU/GPL http://www.gnu.org/copyleft/gpl.html
 */ define(["jquery","fab/fileelement"],function(t,e){window.FbFileUpload=new Class({Extends:e,options:{folderSelect:!1,ajax_upload:!1,ajax_show_widget:!0,isCarousel:!1},initialize:function(e,i){var a=this;this.setPlugin("fileupload"),this.parent(e,i),this.container=t(this.container),this.toppath=this.options.dir,"1"===this.options.folderSelect&&!0===this.options.editable&&this.ajaxFolder(),this.doBrowseEvent=null,this.watchBrowseButton(),this.options.ajax_upload&&!1!==this.options.editable&&(Fabrik.fireEvent("fabrik.fileupload.plupload.build.start",this),this.watchAjax(),0!==Object.keys(this.options.files).length&&(this.uploader.trigger("FilesAdded",this.options.files),t.each(this.options.files,function(e,i){var s={filepath:i.path,uri:i.url,showWidget:!1},o=t(Fabrik.jLayouts["fabrik-progress-bar-success"])[0],n=t("#"+i.id).find(".bar")[0];a.uploader.trigger("UploadProgress",i),a.uploader.trigger("FileUploaded",i,{response:JSON.stringify(s)}),t(n).replaceWith(o)})),this.redraw()),this.doDeleteEvent=null,this.watchDeleteButton(),this.watchTab(),this.options.isCarousel&&(t(".slickCarousel").slick(),t(".slickCarouselImage").css("opacity","1")),this.options.isZoom&&(t(".slick-active").find("img").ezPlus({zoomType:"lens",lensShape:"round",lensSize:200}),t(".slickCarousel").on("beforeChange",function(e,i,a,s){t(".zoomWindowContainer,.zoomContainer").remove()}),t(".slickCarousel").on("afterChange",function(e,i,a){t(".slick-active").find("img").ezPlus({zoomType:"lens",lensShape:"round",lensSize:200})}))},redraw:function(){var e=t(this.element);if(this.options.editable&&this.options.ajax_upload){var i=t("#"+e.prop("id")+"_browseButton"),a=t("#"+this.options.element+"_container"),s=i.position().left-a.position().left,o=a.closest(".fabrikElement").find("input[type=file]");if(o.length>0){var n=o.parent();n.css({width:i.width(),height:i.height()}),n.css("top",s)}}this.options.isCarousel&&t(".slickCarousel").slick("resize")},doBrowse:function(e){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var i,a=this,s=e.target.files[0];if(s.type.match("image.*"))(i=new FileReader).onload=(function(e){return function(e){var i=t(a.getContainer()),s=i.find("img");s.attr("src",e.target.result),s.closest(".fabrikHide").removeClass("fabrikHide"),i.find("[data-file]").addClass("fabrikHide")}}).bind(this)(s),i.readAsDataURL(s);else if(s.type.match("video.*")){var o,n=t(this.getContainer()),r=n.find("video");if(r.length>0&&(r=this.makeVideoPreview()).appendTo(n),i=new window.FileReader,(i=window.URL||window.webKitURL)&&i.createObjectURL){o=i.createObjectURL(s),r.attr("src",o);return}if(!window.FileReader){console.log("Sorry, not so much");return}(i=new window.FileReader).onload=function(t){r.attr("src",t.target.result)},i.readAsDataURL(s)}}},watchBrowseButton:function(){var e=t(this.element);this.options.useWIP&&!this.options.ajax_upload&&!1!==this.options.editable&&(e.off("change",this.doBrowseEvent),this.doBrowseEvent=this.doBrowse.bind(this),e.on("change",this.doBrowseEvent))},doDelete:function(e){e.preventDefault();var i=t(this.getContainer()),a=this,s=i.find("[data-file]");if(console.log(s),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_SOFT_DELETE"))){var o=s.data("join-pk-val");new t.ajax({url:"",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"fileupload",method:"ajax_clearFileReference",element_id:this.options.id,formid:this.form.id,rowid:this.form.options.rowid,joinPkVal:o}}).done(function(){Fabrik.trigger("fabrik.fileupload.clearfileref.complete",a)}),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_HARD_DELETE"))&&(this.makeDeletedImageField(this.groupid,s.data("file")).appendTo(i),Fabrik.fireEvent("fabrik.fileupload.delete.complete",this)),s[0].parentElement.remove(),t(this.element).closest(".fabrikElement").find("img").attr("src",""!==this.options.defaultImage?Fabrik.liveSite+this.options.defaultImage:"")}},watchDeleteButton:function(){var e=t(this.getContainer()).find("[data-file]");e.off("click",this.doDeleteEvent),this.doDeleteEvent=this.doDelete.bind(this),e.on("click",this.doDeleteEvent)},getFormElementsKey:function(t){return(this.baseElementId=t,this.options.ajax_upload&&this.options.ajax_max>1)?this.options.listName+"___"+this.options.elementShortName:this.parent(t)},removeCustomEvents:function(){},cloned:function(e){var i=t(this.element);0!==i.closest(".fabrikElement").length&&(i.closest(".fabrikElement").find("img").attr("src",""!==this.options.defaultImage?Fabrik.liveSite+this.options.defaultImage:""),t(this.getContainer()).find("[data-file]").remove(),this.watchBrowseButton(),this.parent(e))},decloned:function(e){t("#form_"+this.form.id).find('input[name="fabrik_deletedimages['+e+']"]').length>0&&this.makeDeletedImageField(e,this.options.value).inject(this.form.form),this.parent(e)},decreaseName:function(t){var e=this.getOrigField();return"null"!==typeOf(e)&&(e.name=this._decreaseName(e.name,t),e.id=this._decreaseId(e.id,t)),this.parent(t)},getOrigField:function(){var t=this.element.getParent(".fabrikElement"),e=t.getElement("input[name^="+this.origId+"_orig]");return"null"===typeOf(e)&&(e=t.getElement("input[id^="+this.origId+"_orig]")),e},makeDeletedImageField:function(e,i){return t(document.createElement("input")).attr({type:"hidden",name:"fabrik_fileupload_deletedfile["+e+"][]",value:i})},makeVideoPreview:function(){var e=t(this.element);return t(document.createElement("video")).attr({id:e.prop("id")+"_video_preview",controls:!0})},update:function(e){if(this.element){var i=t(this.element);if(""===e)this.options.ajax_upload?(this.uploader.files=[],i.parent().find("[id$=_dropList] tr").remove()):i.val("");else{var a=i.closest("div.fabrikSubElementContainer").find("img");a&&a.prop("src",e)}}},addDropArea:function(){if(Fabrik.bootstraped){var e,i=this.container.find("tr.plupload_droptext");i.length>0?i.show():(e=t(document.createElementget("tr")).addClass("plupload_droptext").html('<td colspan="4"><i class="icon-move"></i> '+Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_DRAG_FILES_HERE")+" </td>"),this.container.find("tbody").append(e)),this.container.find("thead").hide()}},removeDropArea:function(){this.container.find("tr.plupload_droptext").hide()},watchAjax:function(){if(!1!==this.options.editable){var e=this,a=t(this.element).prop("id"),s=t(this.getElement());if(0!==s.length){var o=s.closest(".fabrikSubElementContainer");this.container=o,this.options.ajax_show_widget&&!1!==this.options.canvasSupport&&(this.widget=new i(this.options.modalId,{imagedim:{x:200,y:200,w:this.options.winWidth,h:this.options.winHeight},cropdim:{w:this.options.cropwidth,h:this.options.cropheight,x:this.options.winWidth/2,y:this.options.winHeight/2},crop:this.options.crop,modalId:this.options.modalId,quality:this.options.quality})),this.pluploadContainer=o.find(".plupload_container"),this.pluploadFallback=o.find(".plupload_fallback"),this.droplist=o.find(".plupload_filelist");var n="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax";n+="&plugin=fileupload&"+this.options.ajaxToken+"=1",n+="&method=ajax_upload&element_id="+this.options.elid,this.options.isAdmin&&(n="administrator/"+n);var r={runtimes:this.options.ajax_runtime,browse_button:a+"_browseButton",container:a+"_container",drop_element:a+"_dropList_container",url:n,max_file_size:this.options.max_file_size+"kb",unique_names:!1,flash_swf_url:this.options.ajax_flash_path,silverlight_xap_url:this.options.ajax_silverlight_path,chunk_size:this.options.ajax_chunk_size+"kb",dragdrop:!0,multipart:!0,filters:this.options.filters,page_url:this.options.page_url};this.uploader=new plupload.Uploader(r),this.uploader.bind("Init",function(t,i){e.pluploadFallback.remove(),e.pluploadContainer.removeClass("fabrikHide"),t.features.dragdrop&&t.settings.dragdrop&&e.addDropArea()}),this.uploader.bind("FilesRemoved",function(t,e){}),this.uploader.bind("FilesAdded",function(i,a){e.removeDropArea();var s,o=Fabrik.bootstrapped?"tr":"li";e.lastAddedFiles=a,Fabrik.bootstrapped&&e.container.find("thead").css("display",""),s=e.droplist.find(o).length,t.each(a,function(i,a){if(a.size>1e3*e.options.max_file_size)window.alert(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_FILE_TOO_LARGE_SHORT"));else if(s>=e.options.ajax_max)window.alert(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_MAX_UPLOAD_REACHED"));else{var n,r,l;s++,e.isImage(a)?(n=e.editImgButton(),e.options.crop?n.html(e.options.resizeButton):n.html(e.options.previewButton),r=t(document.createElement("span")).text(a.name)):(n=t(document.createElement("span")),r=t(document.createElement("a")).attr({href:a.url,target:"_blank"}).text(a.name)),l=e.imageCells(a,r,n),e.droplist.append(t(document.createElement(o)).attr({id:a.id,class:"plupload_delete"}).append(l))}}),setTimeout(function(){i.start()},100)}),this.uploader.bind("UploadProgress",function(e,i){var a=t("#"+i.id);if(a.length>0){if(Fabrik.bootstrapped){var s=a.find(".plupload_file_status .bar");if(s.css("width",i.percent+"%"),100===i.percent){var o=t(Fabrik.jLayouts["fabrik-progress-bar-success"]);s.replaceWith(o)}}else a.find(".plupload_file_status").text(i.percent+"%")}}),this.uploader.bind("Error",function(i,a){e.lastAddedFiles.each(function(i){var s=t("#"+i.id);s.length>0&&(s.remove(),window.alert(a.message)),e.addDropArea()})}),this.uploader.bind("ChunkUploaded",function(t,e,i){"object"==typeof(i=JSON.parse(i.response))&&i.error&&fconsole(i.error.message)}),this.uploader.bind("FileUploaded",function(i,a,s){var o,n,r,l,d,r=t("#"+a.id);if((s=JSON.parse(s.response)).error){window.alert(s.error),r.remove();return}if(0===r.length){fconsole("Filuploaded didnt find: "+a.id);return}(l=r.find(".plupload_resize a")).show(),l.attr({href:s.uri,id:"resizebutton_"+a.id}),l.data("filepath",s.filepath),e.widget&&(n=!1!==s.showWidget,e.widget.setImage(s.uri,s.filepath,a.params,n)),o=e.options.inRepeatGroup?e.options.elementName.replace(/\[\d*\]/,"["+e.getRepeatNum()+"]"):e.options.elementName,t(document.createElement("input")).attr({type:"hidden",name:o+"[crop]["+s.filepath+"]",id:"coords_"+a.id,value:JSON.stringify(a.params)}).insertAfter(e.pluploadContainer),t(document.createElement("input")).attr({type:"hidden",name:o+"[cropdata]["+s.filepath+"]",id:"data_"+a.id}).insertAfter(e.pluploadContainer),d=[a.recordid,"0"].pick(),t(document.createElement("input")).attr({type:"hidden",name:o+"[id]["+s.filepath+"]",id:"id_"+a.id,value:d}).insertAfter(e.pluploadContainer),r.removeClass("plupload_file_action").addClass("plupload_done"),e.isSubmitDone()}),this.uploader.init()}}},imageCells:function(e,i,a){var s,o,n,r,l=this.deleteImgButton();return Fabrik.bootstrapped?(r=t(document.createElement("td")).addClass(this.options.spanNames[1]+" plupload_resize").append(a),n=Fabrik.jLayouts["fabrik-progress-bar"],o=t(document.createElement("td")).addClass(this.options.spanNames[5]+" plupload_file_status").html(n),[s=t(document.createElement("td")).addClass(this.options.spanNames[6]+" plupload_file_name").append(i),r,o,l]):(s=new Element("div",{class:"plupload_file_name"}).adopt([i,new Element("div",{class:"plupload_resize",style:"display:none"}).adopt(a)]),[s,l,o=new Element("div",{class:"plupload_file_status"}).set("text","0%"),new Element("div",{class:"plupload_file_size"}).set("text",e.size),new Element("div",{class:"plupload_clearer"})])},editImgButton:function(){var e=this;return Fabrik.bootstrapped?t(document.createElement("a")).addClass("editImage").attr({href:"#",alt:Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_RESIZE")}).css({display:"none"}).on("click",function(i){i.preventDefault(),e.pluploadResize(t(this))}):new Element("a",{href:"#",alt:Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_RESIZE"),events:{click:(function(e){e.stop();var i=e.target.getParent();this.pluploadResize(t(i))}).bind(this)}})},deleteImgButton:function(){if(!Fabrik.bootstrapped)return new Element("div",{class:"plupload_file_action"}).adopt(new Element("a",{href:"#",style:"display:block",events:{click:(function(t){this.pluploadRemoveFile(t)}).bind(this)}}));var e=Fabrik.jLayouts["fabrik-icon-delete"],i=this;return t(document.createElement("td")).addClass(this.options.spanNames[1]+" plupload_file_action").append(t(document.createElement("a")).html(e).attr({href:"#"}).on("click",function(t){t.stopPropagation(),i.pluploadRemoveFile(t)}))},isImage:function(t){return void 0!==t.type?"image"===t.type:["jpg","jpeg","png","gif"].contains(t.name.split(".").pop().toLowerCase())},pluploadRemoveFile:function(e){if(e.stopPropagation(),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_HARD_DELETE"))){var i=t(e.target).closest("tr").prop("id").split("_").pop(),a=t(e.target).closest("tr").find(".plupload_file_name").text(),s=[];this.uploader.files.each(function(t){t.id!==i&&s.push(t)}),this.uploader.files=s;var o=this,n={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"fileupload",method:"ajax_deleteFile",element_id:this.options.id,file:a,recordid:i,repeatCounter:this.options.repeatCounter};n[this.options.ajaxToken]=1,t.ajax({url:"",data:n}).done(function(a){""===(a=JSON.parse(a)).error&&(Fabrik.trigger("fabrik.fileupload.delete.complete",o),t(e.target).closest(".plupload_delete").remove(),t("#id_alreadyuploaded_"+o.options.id+"_"+i).remove(),t("#coords_alreadyuploaded_"+o.options.id+"_"+i).remove(),0===t(o.getContainer()).find("table tbody tr.plupload_delete").length&&o.addDropArea())})}},pluploadResize:function(t){this.widget&&this.widget.setImage(t.attr("href"),t.data("filepath"),{},!0)},isSubmitDone:function(){this.allUploaded()&&"function"==typeof this.submitCallBack&&(this.saveWidgetState(),this.submitCallBack(!0),delete this.submitCallBack)},onsubmit:function(t){this.submitCallBack=t,this.allUploaded()?(this.saveWidgetState(),this.parent(t)):this.uploader.start()},saveWidgetState:function(){void 0!==this.widget&&t.each(this.widget.images,function(e,i){var a=t('input[name*="'+(e=e.split("\\").pop())+'"]').filter(function(t,e){return e.name.contains("[crop]")});if((a=a.last()).length>0){var s=i.img;delete i.img,a.val(JSON.stringify(i)),i.img=s}})},allUploaded:function(){var t=!0;return this.uploader&&this.uploader.files.each(function(e){0===e.loaded&&(t=!1)}),t}});var i=new Class({initialize:function(e,i){this.modalId=e,Fabrik.Windows[this.modalId]&&(Fabrik.Windows[this.modalId].options.destroy=!0,Fabrik.Windows[this.modalId].close()),this.imageDefault={rotation:0,scale:100,imagedim:{x:200,y:200,w:400,h:400},cropdim:{x:75,y:25,w:150,h:50}},t.extend(this.imageDefault,i),this.windowopts={id:this.modalId,type:"modal",loadMethod:"html",width:parseInt(this.imageDefault.imagedim.w,10)+40,height:parseInt(this.imageDefault.imagedim.h,10)+170,storeOnClose:!0,createShowOverLay:!1,crop:i.crop,destroy:!1,modalId:i.modalId,quality:i.quality,onClose:(function(){this.storeActiveImageData()}).bind(this),onContentLoaded:function(){this.center()},onOpen:function(){this.center()}},this.windowopts.title=i.crop?Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CROP_AND_SCALE"):Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_PREVIEW"),this.showWin(),this.canvas=t(this.window).find("canvas")[0],this.images={},this.CANVAS=new FbCanvas({canvasElement:this.canvas,enableMouse:!0,cacheCtxPos:!1}),this.CANVAS.layers.add(new Layer({id:"bg-layer"})),this.CANVAS.layers.add(new Layer({id:"image-layer"})),i.crop&&(this.CANVAS.layers.add(new Layer({id:"overlay-layer"})),this.CANVAS.layers.add(new Layer({id:"crop-layer"})));var a=new CanvasItem({id:"bg",scale:1,events:{onDraw:(function(t){void 0===t&&(t=this.CANVAS.ctx),t.fillStyle="#DFDFDF",t.fillRect(0,0,this.imageDefault.imagedim.w/this.scale,this.imageDefault.imagedim.h/this.scale)}).bind(this)}});this.CANVAS.layers.get("bg-layer").add(a),i.crop&&(this.overlay=new CanvasItem({id:"overlay",events:{onDraw:(function(t){if(void 0===t&&(t=this.CANVAS.ctx),this.overlay.withinCrop){var e={x:0,y:0},i={x:this.imageDefault.imagedim.w,y:this.imageDefault.imagedim.h};t.fillStyle="rgba(0, 0, 0, 0.3)";var a=this.cropperCanvas;t.fillRect(e.x,e.y,i.x,a.y-a.h/2),t.fillRect(e.x-a.w/2,e.y+a.y-a.h/2,e.x+a.x,a.h),t.fillRect(e.x+a.x+a.w-a.w/2,e.y+a.y-a.h/2,i.x,a.h),t.fillRect(e.x,e.y+(a.y+a.h)-a.h/2,i.x,i.y)}}).bind(this)}}),this.CANVAS.layers.get("overlay-layer").add(this.overlay)),this.imgCanvas=this.makeImgCanvas(),this.CANVAS.layers.get("image-layer").add(this.imgCanvas),this.cropperCanvas=this.makeCropperCanvas(),i.crop&&this.CANVAS.layers.get("crop-layer").add(this.cropperCanvas),this.makeThread(),this.watchZoom(),this.watchRotate(),this.watchClose(),this.win.close()},setImage:function(e,i,a,s){if(s=!!s&&s,this.activeFilePath=i,this.images.hasOwnProperty(i))a=this.images[i],this.img=a.img,this.setInterfaceDimensions(a),s&&this.showWin();else var o=a,n=Asset.image(e,{crossOrigin:"anonymous",onLoad:(function(){var e=this.storeImageDimensions(i,t(n),o);this.img=e.img,this.setInterfaceDimensions(e),this.showWin(),this.storeActiveImageData(i),s||this.win.close()}).bind(this)})},setInterfaceDimensions:function(t){this.scaleSlide&&this.scaleSlide.set(t.scale),this.rotateSlide&&this.rotateSlide.set(t.rotation),this.cropperCanvas&&t.cropdim&&(this.cropperCanvas.x=t.cropdim.x,this.cropperCanvas.y=t.cropdim.y,this.cropperCanvas.w=t.cropdim.w,this.cropperCanvas.h=t.cropdim.h),this.imgCanvas.w=t.mainimagedim.w,this.imgCanvas.h=t.mainimagedim.h,this.imgCanvas.x=void 0!==t.imagedim?t.imagedim.x:0,this.imgCanvas.y=void 0!==t.imagedim?t.imagedim.y:0},storeImageDimensions:function(t,e,i){e.appendTo(document.body).css({display:"none"}),i=i||new CloneObject(this.imageDefault,!0,[]);var a=e[0].getDimensions(!0);return i.imagedim?i.mainimagedim=i.imagedim:i.mainimagedim={},i.mainimagedim.w=a.width,i.mainimagedim.h=a.height,i.img=e[0],this.images[t]=i,i},makeImgCanvas:function(){var t=this;return new CanvasItem({id:"imgtocrop",w:this.imageDefault.imagedim.w,h:this.imageDefault.imagedim.h,x:200,y:200,interactive:!0,rotation:0,scale:1,offset:[0,0],events:{onMousemove:function(t,e){if(this.dragging){var i=this.w*this.scale,a=this.h*this.scale;this.x=t-this.offset[0]+.5*i,this.y=e-this.offset[1]+.5*a}},onDraw:function(e){if(e=t.CANVAS.ctx,void 0!==t.img){var i=this.w*this.scale,a=this.h*this.scale,s=this.x-.5*i,o=this.y-.5*a;if(e.save(),e.translate(this.x,this.y),e.rotate(this.rotation*Math.PI/180),this.hover?e.strokeStyle="#f00":e.strokeStyle="#000",e.strokeRect(-.5*i,-.5*a,i,a),void 0!==t.img)try{e.drawImage(t.img,-.5*i,-.5*a,i,a)}catch(n){}e.restore(),void 0!==t.img&&t.images.hasOwnProperty(t.activeFilePath)&&(t.images[t.activeFilePath].imagedim={x:this.x,y:this.y,w:i,h:a}),this.setDims(s,o,i,a)}},onMousedown:function(e,i){t.CANVAS.setDrag(this),this.offset=[e-this.dims[0],i-this.dims[1]],this.dragging=!0},onMouseup:function(){t.CANVAS.clearDrag(),this.dragging=!1},onMouseover:function(){t.overImg=!0,document.body.style.cursor="move"},onMouseout:function(){t.overImg=!1,t.overCrop||(document.body.style.cursor="default")}}})},makeCropperCanvas:function(){var t=this;return new CanvasItem({id:"item",x:175,y:175,w:150,h:50,interactive:!0,offset:[0,0],events:{onDraw:function(e){if(void 0!==(e=t.CANVAS.ctx)){var i=this.w,a=this.h,s=this.x-.5*i,o=this.y-.5*a;e.save(),e.translate(this.x,this.y),this.hover?e.strokeStyle="#f00":e.strokeStyle="#000",e.strokeRect(-.5*i,-.5*a,i,a),e.restore(),void 0!==t.img&&t.images.hasOwnProperty(t.activeFilePath)&&(t.images[t.activeFilePath].cropdim={x:this.x,y:this.y,w:i,h:a}),this.setDims(s,o,i,a)}},onMousedown:function(e,i){t.CANVAS.setDrag(this),this.offset=[e-this.dims[0],i-this.dims[1]],this.dragging=!0,t.overlay.withinCrop=!0},onMousemove:function(t,e){if(document.body.style.cursor="move",this.dragging){var i=this.w,a=this.h;this.x=t-this.offset[0]+.5*i,this.y=e-this.offset[1]+.5*a}},onMouseup:function(){t.CANVAS.clearDrag(),this.dragging=!1,t.overlay.withinCrop=!1},onMouseover:function(){this.hover=!0,t.overCrop=!0},onMouseout:function(){t.overImg||(document.body.style.cursor="default"),t.overCrop=!1,this.hover=!1}}})},makeThread:function(){var t=this;this.CANVAS.addThread(new Thread({id:"myThread",onExec:function(){void 0!==t.CANVAS&&void 0!==t.CANVAS.ctxEl&&t.CANVAS.clear().draw()}}))},watchClose:function(){var t=this;this.window.find("input[name=close-crop]").on("click",function(e){t.storeActiveImageData(),t.win.close()})},storeActiveImageData:function(e){if(void 0!==(e=e||this.activeFilePath)){var i=this.cropperCanvas.x,a=this.cropperCanvas.y,s=this.cropperCanvas.w-2,o=this.cropperCanvas.h-2;i-=s/2,a-=o/2;var n=t("#"+this.windowopts.id);if(0===n.length){fconsole("storeActiveImageData no window found for "+this.windowopts.id);return}var r=n.find("canvas"),l=t(document.createElement("canvas")).attr({width:s+"px",height:o+"px"}).appendTo(document.body),d=l[0].getContext("2d"),h=t('input[name*="'+e.split("\\").pop()+'"]').filter(function(t,e){return e.name.contains("cropdata")});d.drawImage(r[0],i,a,s,o,0,0,s,o),h.val(l[0].toDataURL("image/jpeg",this.windowopts.quality)),l.remove()}},watchZoom:function(){var e=this;if(this.windowopts.crop){var i=this.window.find("input[name=zoom-val]");this.scaleSlide=new Slider(this.window.find(".fabrikslider-line")[0],this.window.find(".knob")[0],{range:[20,300],onChange:function(t){if(e.imgCanvas.scale=t/100,void 0!==e.img)try{e.images[e.activeFilePath].scale=t}catch(a){fconsole("didnt get active file path:"+e.activeFilePath)}i.val(t)}}).set(100),i.on("change",function(i){e.scaleSlide.set(t(this).val())})}},watchRotate:function(){if(this.windowopts.crop){var e=this,i=this.window.find(".rotate"),a=this.window.find("input[name=rotate-val]");this.rotateSlide=new Slider(i.find(".fabrikslider-line")[0],i.find(".knob")[0],{onChange:function(t){if(e.imgCanvas.rotation=t,void 0!==e.img)try{e.images[e.activeFilePath].rotation=t}catch(i){fconsole("rorate err"+e.activeFilePath)}a.val(t)},steps:360}).set(0),a.on("change",function(){e.rotateSlide.set(t(this).val())})}},showWin:function(){this.win=Fabrik.getWindow(this.windowopts),this.window=t("#"+this.modalId),void 0!==this.CANVAS&&(void 0!==this.CANVAS.ctxEl&&(this.CANVAS.ctxPos=document.id(this.CANVAS.ctxEl).getPosition()),void 0!==this.CANVAS.threads&&void 0!==this.CANVAS.threads.get("myThread")&&this.CANVAS.threads.get("myThread").start(),this.win.drawWindow(),this.win.center())}});return window.FbFileUpload});