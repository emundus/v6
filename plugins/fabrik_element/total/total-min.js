/*! Fabrik */

define(["jquery","fab/element"],function(h,e){return window.FbTotal=new Class({Extends:e,observeGroupIds:[],observeElementGroups:[],initialize:function(e,t){this.setPlugin("FbTotal"),this.parent(e,t),this.observeGroupIds=[]},attachedToForm:function(){this.options.observe.each(function(e){this.addObserveEvent(e)}.bind(this)),this.options.totalOnLoad&&this.calc(),Fabrik.addEvent("fabrik.cdd.update",function(e){e.hasSubElements()&&-1!==h.inArray(e.baseElementId,this.options.observe)&&this.addObserveEvent(e.baseElementId)}.bind(this)),Fabrik.addEvent("fabrik.form.group.duplicate.end",function(e,t,s){-1!==h.inArray(s,this.observeGroupIds)&&this.calc()}.bind(this)),Fabrik.addEvent("fabrik.form.group.delete.end",function(e,t,s){-1!==h.inArray(s,this.observeGroupIds)&&this.calc()}.bind(this)),this.parent()},addObserveEvent:function(s){var i,o;""!==s&&(this.form.formElements[s]?this.form.formElements[s].addNewEventAux(this.form.formElements[s].getChangeEvent(),function(e){this.calc(e)}.bind(this)):this.options.canRepeat?(i=s+"_"+this.options.repeatCounter,this.form.formElements[i]&&this.form.formElements[i].addNewEventAux(this.form.formElements[i].getChangeEvent(),function(e){this.calc(e)}.bind(this))):this.form.repeatGroupMarkers.each(function(e,t){for(i="",o=0;o<e;o++)i=s+"_"+o,this.form.formElements[i]&&(this.form.formElements[i].addNewEvent(this.form.formElements[i].getChangeEvent(),function(e){this.calc(e)}.bind(this)),-1===h.inArray(t,this.observeGroupIds)&&(this.observeGroupIds.push(t),this.observeElementGroups[s]=t))}.bind(this)))},calc:function(){var a=this,d=parseFloat(this.options.startValue);switch(this.options.method){case"sum_repeat":h.each(this.options.observe,function(e,t){for(var s=a.form.repeatGroupMarkers[a.observeElementGroups[t]],i=0;i<s;i++){var o=a.form.formElements.get(t+"_"+i);if(o){var r=o.getValue();if(h.isNumeric(r)){var n=a.options.operands[e];switch(r=parseFloat(r),n){case"add":d+=r;break;case"subtract":d-=r;break;case"multiply":d*=r;break;case"divide":0!==r&&(d/=r)}}}}});break;case"sum_multiple":h.each(this.options.observe,function(e,t){a.options.canRepeat&&(t=t+"_"+a.options.repeatCounter);var s=a.form.formElements.get(t);if(s){var i=s.getValue();if(h.isNumeric(i)){var o=a.options.operands[e];switch(i=parseFloat(i),o){case"add":d+=i;break;case"subtract":d-=i;break;case"multiply":d*=i;break;case"divide":0!==i&&(d/=i)}}}})}this.update(d.toFixed(a.options.fixed))}}),window.FbTotal});