services:
  - docker:20.10-dind

variables:
  GIT_SUBMODULE_STRATEGY: normal
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  BUILDKIT_INLINE_CACHE: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  DOCKER_TLS_CERTDIR: ""
  DOCKER_CLIENT_TIMEOUT: 360
  COMPOSE_HTTP_TIMEOUT: 360

stages:
  - check
  - build
  - test
  - release
  - publish

check-tchooz-version-job:
  stage: check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH'
      when: always
    - when: never
  image: enix/ci-toolbox
  script:
    - .ci/file-search-in-gitlab-merge-request.sh "$CI_SERVER_URL" "$GITLAB_TOKEN" "$CI_PROJECT_ID" "$CI_MERGE_REQUEST_IID" "administrator/components/com_emundus/emundus.xml"

build-app-to-test-job:
  stage: build
  image: docker:20.10
  before_script: 
    - echo $DOCKER_REGISTRY_TOKEN | docker login -u $DOCKER_REGISTRY_USER --password-stdin
  script:
    - docker pull emundus/tchooz-build-app:latest || true
    - docker build --cache-from emundus/tchooz-build-app:latest --compress -t emundus/tchooz-build-app:latest -t emundus/tchooz-build-app:$CI_COMMIT_SHORT_SHA --build-arg=BUILDKIT_INLINE_CACHE=1 --build-arg xdebug=1 --build-arg jest=1 .
    - docker push emundus/tchooz-build-app:$CI_COMMIT_SHORT_SHA
    - docker push emundus/tchooz-build-app:latest
  only:
    - merge_request

build-db-to-test-job:
  stage: build
  image: docker:20.10
  before_script: 
    - echo $DOCKER_REGISTRY_TOKEN | docker login -u $DOCKER_REGISTRY_USER --password-stdin
  script:
    - docker pull emundus/tchooz-build-db:latest || true
    - docker build --cache-from emundus/tchooz-build-db:latest --compress -f Dockerfile.db -t emundus/tchooz-build-db:latest -t emundus/tchooz-build-db:$CI_COMMIT_SHORT_SHA --build-arg=BUILDKIT_INLINE_CACHE=1 .
    - docker push emundus/tchooz-build-db:$CI_COMMIT_SHORT_SHA
    - docker push emundus/tchooz-build-db:latest
  only:
    - merge_request

phpunit-job:
  stage: test
  image: emundus/tchooz-build-app:$CI_COMMIT_SHORT_SHA
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  services:
    - name: emundus/tchooz-build-db:$CI_COMMIT_SHORT_SHA
      alias: database
    - redis:latest
  variables:
    TCHOOZ_OFFLINE: 0
    TCHOOZ_OFFLINE_MESSAGE: Offline
    TCHOOZ_DISPLAY_OFFLINE_MESSAGE: 1
    TCHOOZ_OFFLINE_IMAGE: images/logo.png
    TCHOOZ_SITENAME: Tchooz
    TCHOOZ_EDITOR: tinymce
    TCHOOZ_DEBUG: 0
    TCHOOZ_DEBUG_LANG: 0
    TCHOOZ_DB_HOST: database
    TCHOOZ_DB_USER: tchooz
    TCHOOZ_DB_PASSWORD: tchooz_password
    TCHOOZ_DB_NAME: vanilla
    TCHOOZ_LIVE_SITE: 
    TCHOOZ_SECRET: ${TCHOOZ_SECRET}
    TCHOOZ_OFFSET: Europe/Paris
    TCHOOZ_MAILER: smtp
    TCHOOZ_MAIL_FROM: 
    TCHOOZ_MAIL_FROM_NAME: 
    TCHOOZ_MAIL_SMTP_AUTH: 
    TCHOOZ_MAIL_SMTP_USER: 
    TCHOOZ_MAIL_SMTP_PASS: 
    TCHOOZ_MAIL_SMTP_HOST: 
    TCHOOZ_MAIL_SMTP_SECURITY: 
    TCHOOZ_MAIL_SMTP_PORT: 
    TCHOOZ_CACHING: 0
    TCHOOZ_CACHE_HANDLER: redis
    TCHOOZ_CACHE_LIFETIME: 15
    TCHOOZ_META_DESCRIPTION: Tchooz
    TCHOOZ_META_KEYS: tchooz
    TCHOOZ_LOG_PATH: /var/www/html/logs
    TCHOOZ_TMP_PATH: /var/www/html/tmp
    TCHOOZ_SESSION_LIFETIME: 15
    TCHOOZ_SESSION_HANDLER: redis
    TCHOOZ_FORCE_SSL: 0
    TCHOOZ_REDIS_PERSIST: 1
    TCHOOZ_REDIS_HOST: redis
    TCHOOZ_REDIS_PORT: 6379
    TCHOOZ_REDIS_DB: 0
    TCHOOZ_MAIL_REPLY_TO: 
    TCHOOZ_MAIL_REPLY_TO_NAME: 
    TCHOOZ_SESSION_REDIS_PERSIST: 1
    TCHOOZ_SESSION_REDIS_HOST: redis
    TCHOOZ_SESSION_REDIS_PORT: 6379
    TCHOOZ_SESSION_REDIS_DB: 0
    TCHOOZ_PROSPECT: 0
    TCHOOZ_PLAN_LIMIT_APP_FORMS: 0
    TCHOOZ_PLAN_LIMIT_STORAGE_SPACE: 0
    TCHOOZ_PLAN_LIMIT_FORMS: 0
    TCHOOZ_BEHIND_LOADBALANCER: 0
    TCHOOZ_ADMIN_ACCESS_TOKEN: ${TCHOOZ_ADMIN_ACCESS_TOKEN}
    TCHOOZ_COORD_USERNAME: coordinator
    TCHOOZ_COORD_MAIL: ${TCHOOZ_COORD_MAIL}
    TCHOOZ_COORD_FIRST_NAME: Coordinator
    TCHOOZ_COORD_LAST_NAME: Tchooz
    TCHOOZ_COORD_PASSWORD: ${TCHOOZ_COORD_PASSWORD}
    TCHOOZ_INSTANCE_ID: 999999
    TCHOOZ_CUSTOMER_ID: 999999
  before_script:
    - /scripts/entrypoint.sh && echo $?
  script:
    - cd /var/www/html/ && /var/www/html/libraries/emundus/phpunit.phar -c /var/www/html/phpunit.xml --coverage-text --colors=never && echo $?
  only:
    - merge_request

jest-job:
  stage: test
  image: emundus/tchooz-build-app:$CI_COMMIT_SHORT_SHA
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  services:
    - name: emundus/tchooz-build-db:$CI_COMMIT_SHORT_SHA
      alias: database
    - redis:latest
  variables:
    TCHOOZ_OFFLINE: 0
    TCHOOZ_OFFLINE_MESSAGE: Offline
    TCHOOZ_DISPLAY_OFFLINE_MESSAGE: 1
    TCHOOZ_OFFLINE_IMAGE: images/logo.png
    TCHOOZ_SITENAME: Tchooz
    TCHOOZ_EDITOR: tinymce
    TCHOOZ_DEBUG: 0
    TCHOOZ_DEBUG_LANG: 0
    TCHOOZ_DB_HOST: database
    TCHOOZ_DB_USER: tchooz
    TCHOOZ_DB_PASSWORD: tchooz_password
    TCHOOZ_DB_NAME: vanilla
    TCHOOZ_LIVE_SITE: 
    TCHOOZ_SECRET: ${TCHOOZ_SECRET}
    TCHOOZ_OFFSET: Europe/Paris
    TCHOOZ_MAILER: smtp
    TCHOOZ_MAIL_FROM: 
    TCHOOZ_MAIL_FROM_NAME: 
    TCHOOZ_MAIL_SMTP_AUTH: 
    TCHOOZ_MAIL_SMTP_USER: 
    TCHOOZ_MAIL_SMTP_PASS: 
    TCHOOZ_MAIL_SMTP_HOST: 
    TCHOOZ_MAIL_SMTP_SECURITY: 
    TCHOOZ_MAIL_SMTP_PORT: 
    TCHOOZ_CACHING: 0
    TCHOOZ_CACHE_HANDLER: redis
    TCHOOZ_CACHE_LIFETIME: 15
    TCHOOZ_META_DESCRIPTION: Tchooz
    TCHOOZ_META_KEYS: tchooz
    TCHOOZ_LOG_PATH: /var/www/html/logs
    TCHOOZ_TMP_PATH: /var/www/html/tmp
    TCHOOZ_SESSION_LIFETIME: 15
    TCHOOZ_SESSION_HANDLER: redis
    TCHOOZ_FORCE_SSL: 0
    TCHOOZ_REDIS_PERSIST: 1
    TCHOOZ_REDIS_HOST: redis
    TCHOOZ_REDIS_PORT: 6379
    TCHOOZ_REDIS_DB: 0
    TCHOOZ_MAIL_REPLY_TO: 
    TCHOOZ_MAIL_REPLY_TO_NAME: 
    TCHOOZ_SESSION_REDIS_PERSIST: 1
    TCHOOZ_SESSION_REDIS_HOST: redis
    TCHOOZ_SESSION_REDIS_PORT: 6379
    TCHOOZ_SESSION_REDIS_DB: 0
    TCHOOZ_PROSPECT: 0
    TCHOOZ_PLAN_LIMIT_APP_FORMS: 0
    TCHOOZ_PLAN_LIMIT_STORAGE_SPACE: 0
    TCHOOZ_PLAN_LIMIT_FORMS: 0
    TCHOOZ_BEHIND_LOADBALANCER: 0
    TCHOOZ_ADMIN_ACCESS_TOKEN: ${TCHOOZ_ADMIN_ACCESS_TOKEN}
    TCHOOZ_COORD_USERNAME: coordinator
    TCHOOZ_COORD_MAIL: ${TCHOOZ_COORD_MAIL}
    TCHOOZ_COORD_FIRST_NAME: Coordinator
    TCHOOZ_COORD_LAST_NAME: Tchooz
    TCHOOZ_COORD_PASSWORD: ${TCHOOZ_COORD_PASSWORD}
    TCHOOZ_INSTANCE_ID: 999999
    TCHOOZ_CUSTOMER_ID: 999999
  before_script:
    - /scripts/entrypoint.sh && echo $?
  script:
    - cd /var/www/html/components && yarn run test:unit com_emundus/ --ci --coverage && echo $?
  only:
    - merge_request

release-job:
  stage: release
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - administrator/components/com_emundus/emundus.xml
      when: on_success
    - when: never
  image: emundus/semantic-release:latest
  script:
    - semantic-release
  artifacts:
    reports:
      dotenv: release.env

sync-documentation-job:
  stage: release
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - administrator/components/com_emundus/emundus.xml
      when: on_success
    - when: never
  image: emundus/sync-documentation:1.0.0
  script:
    - /go/generate-release-note.sh "$CI_SERVER_URL" "$CI_PROJECT_ID" "$GITLAB_TOKEN" "$ATLASSIAN_URL" "$ATLASSIAN_USER" "$ATLASSIAN_TOKEN" "$ATLASSIAN_SPACE" "$ATLASSIAN_PARENT_PAGE" "$ATLASSIAN_PAGE_TITLE"
  needs:
    - release-job

publish-app-image-job:
  stage: publish
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - administrator/components/com_emundus/emundus.xml
      when: on_success
    - when: never
  image: docker:20.10
  before_script: 
    - echo $DOCKER_REGISTRY_TOKEN | docker login -u $DOCKER_REGISTRY_USER --password-stdin
  script:
    - docker pull emundus/tchooz-app:latest || true
    - docker build --cache-from emundus/tchooz-app:latest --compress -t emundus/tchooz-app:$NEW_VERSION -t emundus/tchooz-app:latest .
    - docker push emundus/tchooz-app:$NEW_VERSION
    - docker push emundus/tchooz-app:latest
  needs:
    - release-job

publish-db-image-job:
  stage: publish
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - administrator/components/com_emundus/emundus.xml
      when: on_success
    - when: never
  image: docker:20.10
  before_script: 
    - echo $DOCKER_REGISTRY_TOKEN | docker login -u $DOCKER_REGISTRY_USER --password-stdin
  script:
    - docker pull emundus/tchooz-db:latest || true
    - docker build --cache-from emundus/tchooz-db:latest --compress -f Dockerfile.db -t emundus/tchooz-db:$NEW_VERSION -t emundus/tchooz-db:latest .
    - docker push emundus/tchooz-db:$NEW_VERSION
    - docker push emundus/tchooz-db:latest
  needs:
    - release-job
